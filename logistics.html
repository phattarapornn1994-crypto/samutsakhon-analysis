<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á / ‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
    }

    header {
      background: #1e293b;
      padding: 12px 16px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header .brand {
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }
    header nav a {
      color: #94a3b8;
      margin-right: 12px;
      text-decoration: none;
      font-size: 13px;
    }
    header nav a:hover {
      color: #fff;
    }
    header nav a.active {
      color: #38bdf8;
      font-weight: 600;
    }

    main {
      display: grid;
      grid-template-columns: minmax(240px, 320px) 1fr;
      height: 100%;
      min-height: 0;
    }

    /* ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢: control + summary */
    #side-panel {
      background: #1e2538;
      background: #1e293b;
      border-right: 1px solid #334155;
      padding: 16px;
      font-size: 13px;
      line-height: 1.5;
      color: #cbd5e1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #side-panel h2 {
      margin: 0 0 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .control-block {
      background: rgba(15,23,42,.6);
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .control-block label {
      font-size: 12px;
      color: #94a3b8;
      display: block;
      margin-bottom: 6px;
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: #fff;
      font-weight: 500;
    }
    .control-row input[type="range"] {
      width: 100%;
    }

    .radio-group {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(90px,1fr));
      gap: 8px;
      font-size: 12px;
    }
    .radio-option {
      background:#0f172a;
      border:1px solid #334155;
      border-radius:8px;
      padding:8px;
      cursor:pointer;
      color:#fff;
      text-align:left;
      line-height:1.4;
    }
    .radio-option input {
      margin-right:6px;
      accent-color:#38bdf8;
    }

    .stats-block {
      background: rgba(15,23,42,.6);
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
      font-size: 12px;
      line-height: 1.4;
      color: #cbd5e1;
    }

    .stats-block .number-strong {
      font-size: 16px;
      font-weight:600;
      color:#fff;
    }

    #topList {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      background: rgba(15,23,42,.6);
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 12px;
      line-height: 1.4;
      color: #cbd5e1;
    }

    .poi-item {
      border-bottom:1px solid #334155;
      padding:8px 0;
    }
    .poi-item:last-child {
      border-bottom:0;
    }
    .poi-name {
      color:#fff;
      font-weight:600;
      font-size:13px;
      line-height:1.4;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .poi-meta {
      font-size:12px;
      color:#94a3b8;
      line-height:1.4;
      margin-top:2px;
    }

    .badge {
      display:inline-block;
      font-size:10px;
      line-height:1.4;
      font-weight:600;
      border-radius:6px;
      padding:2px 6px;
      border:1px solid #475569;
    }
    .badge-red { background:#7f1d1d; color:#fff; border-color:#ef4444; }
    .badge-blue { background:#1e3a8a; color:#fff; border-color:#3b82f6; }
    .badge-green { background:#064e3b; color:#fff; border-color:#10b981; }

    #strategyBox {
      background:#0f172a;
      border:1px solid #334155;
      border-radius:8px;
      padding:10px 12px;
      margin-top:12px;
      font-size:12px;
      line-height:1.5;
      color:#cbd5e1;
    }
    #strategyBox .title {
      font-size:12px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
    }

    /* ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤: ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
    #map-area {
      position: relative;
      background:#000;
      min-height:0;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      position:absolute;
      inset:0;
    }

    /* ‡∏õ‡∏£‡∏±‡∏ö popup ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô dark */
    .leaflet-popup-content-wrapper {
      background:#1e293b;
      color:#f8fafc;
      border-radius:12px;
      border:1px solid #475569;
      box-shadow:0 20px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:#1e293b;
      border:1px solid #475569;
    }
    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:#cbd5e1;
      line-height:1.4;
    }

    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ Spatial Intelligence</div>
    <nav>
      <a href="index.html">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</a>
      <a href="map.html">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
      <a href="competition.html">‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á</a>
      <a href="customers.html">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
      <a href="population.html">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</a>
      <a href="forecast.html">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
      <a href="risk.html">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</a>
      <a href="logistics.html" class="active">‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå</a>
    </nav>
  </header>

  <main>
    <!-- ---------------------------------
         PANEL ‡∏ã‡πâ‡∏≤‡∏¢
    ----------------------------------- -->
    <aside id="side-panel">
      <h2>üì¶ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á / ‡∏à‡∏∏‡∏î‡∏õ‡πâ‡∏≠‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>

      <!-- ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á -->
      <div class="control-block">
        <label>‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á / ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á ‡∏à‡∏≤‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á (‡∏Å‡∏°.)</label>
        <div class="control-row">
          <div><span id="radiusValue" style="color:#38bdf8;font-weight:600;">5</span> ‡∏Å‡∏°.</div>
        </div>
        <input id="radiusInput" type="range" min="1" max="30" step="1" value="5" />
        <div style="font-size:11px;color:#64748b;margin-top:6px;line-height:1.4;">
          ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà = ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÉ‡∏ô‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        </div>
      </div>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
      <div class="control-block">
        <label>‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å</label>
        <div class="radio-group" id="focusGroup">
          <label class="radio-option">
            <input type="radio" name="focus" value="customer" checked />
            ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å<br/> (‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å / ‡∏™‡∏∏‡∏£‡∏≤)
          </label>
          <label class="radio-option">
            <input type="radio" name="focus" value="competitor" />
            ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)
          </label>
          <label class="radio-option">
            <input type="radio" name="focus" value="all" />
            ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </label>
        </div>
      </div>

      <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
      <div class="stats-block">
        <div><b style="color:#fff;">‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ <span id="radiusKMText">5</span> ‡∏Å‡∏°.</b></div>
        <div style="margin-top:6px;">
          ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á/‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á):
          <span class="number-strong" id="statCustomers">0</span> ‡∏à‡∏∏‡∏î
        </div>
        <div>
          ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•:
          <span class="number-strong" id="statCompetitors">0</span> ‡∏à‡∏∏‡∏î
        </div>
        <div>
          ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏£‡∏ß‡∏°:
          <span class="number-strong" id="statTotal">0</span> ‡∏à‡∏∏‡∏î
        </div>
      </div>

      <!-- list ‡∏à‡∏∏‡∏î‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î -->
      <div id="topList">
        <div style="color:#fff;font-weight:600;font-size:13px;margin-bottom:8px;">
          ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Top 10)
        </div>
        <div id="topItems">
          <!-- inject -->
        </div>

        <div id="strategyBox">
          <div class="title">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå</div>
          <div id="strategyText">
            -
          </div>
        </div>
      </div>
    </aside>

    <!-- ---------------------------------
         MAP ‡∏Ç‡∏ß‡∏≤
    ----------------------------------- -->
    <section id="map-area">
      <div id="map"></div>
    </section>
  </main>

  <footer>
    ¬© ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏ï‡πâ‡∏ô‡∏ô‡πâ‡∏≥-‡∏õ‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥ ¬∑ ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏™‡πâ‡∏ô (Haversine) ¬∑ Prototype
  </footer>

  <script>
    // -------------------------------------------------
    // CONFIG ‡∏´‡∏•‡∏±‡∏Å
    // -------------------------------------------------
    // ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏≤ = ‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á (‡πÅ‡∏Å‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå)
    const HUB = {
      name: "‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á (‡∏ê‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£)",
      lat: 13.565126,
      lng: 100.279895,
      address: "‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏¢‡πÉ‡∏¢‡∏£‡∏±‡∏Å ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£"
    };

    // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏£‡∏∞‡∏ö‡∏∏ "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" ‡∏Å‡∏±‡∏ö "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á"
    function isCompetitorRow(cat) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• = ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á
      return cat.includes("‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•");
    }

    function isCustomerRow(cat) {
      // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏£‡∏≤: ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å / ‡∏™‡∏∏‡∏£‡∏≤
      // ‡∏õ‡∏£‡∏±‡∏ö keyword ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô factories.csv ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      const keywords = ["‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©", "‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å", "‡∏™‡∏∏‡∏£‡∏≤", "‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå", "‡πÅ‡∏û‡∏Ñ‡πÄ‡∏Å‡∏à"];
      return keywords.some(k => cat.includes(k));
    }

    // -------------------------------------------------
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á Haversine (‡∏Å‡∏°.)
    // -------------------------------------------------
    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371; // km
      const dLat = (lat2 - lat1) * Math.PI/180;
      const dLon = (lon2 - lon1) * Math.PI/180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) *
        Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // -------------------------------------------------
    // ‡∏≠‡πà‡∏≤‡∏ô CSV (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô map/competition)
    // columns:
    // category,name,detail,"address ...",lat,lng
    // -------------------------------------------------
    function parseFactoriesCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const rows = [];

      let startIndex = 0;
      const first = lines[0].toLowerCase();
      const headerLike = first.includes('category') || first.includes('lat');
      if (headerLike) startIndex = 1;

      for (let i = startIndex; i < lines.length; i++) {
        let row = lines[i].trim();
        if (!row) continue;

        // extract "address, maybe commas"
        let addressFixed = "";
        const quotedMatch = row.match(/"([^"]*)"/);
        if (quotedMatch) {
          addressFixed = quotedMatch[1].trim();
          row = row.replace(quotedMatch[0], "##ADDRESS##");
        }

        const parts = row.split(',').map(p => p.trim());

        if (parts.length < 6) continue;

        const category = parts[0] || "";
        const name = parts[1] || "";
        const detail = parts[2] || "";

        let address = parts[3] || "";
        if (address === "##ADDRESS##") {
          address = addressFixed;
        }

        const lat = parseFloat(parts[4]);
        const lng = parseFloat(parts[5]);
        if (isNaN(lat) || isNaN(lng)) continue;

        rows.push({
          category,
          name,
          detail,
          address,
          lat,
          lng
        });
      }

      return rows;
    }

    // -------------------------------------------------
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
    // -------------------------------------------------
    let map;
    let baseStreet, baseSat;
    let hubLayer;           // marker HUB
    let poiLayer;           // markers ‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let radiusCircle;       // ‡∏ß‡∏á‡∏£‡∏±‡∏®‡∏°‡∏µ
    let allPOIs = [];       // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å CSV ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞
    let currentFocus = "customer"; // customer | competitor | all

    // -------------------------------------------------
    // popup HTML
    // -------------------------------------------------
    function popupHTML(p) {
      return `
        <div class="popup-title">${p.name || "-"}</div>
        <div class="popup-desc">
          <div><strong>‡∏´‡∏°‡∏ß‡∏î:</strong> ${p.category || "-"}</div>
          <div><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${p.detail || "-"}</div>
          <div><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${p.address || "-"}</div>
          <div><strong>‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏®‡∏π‡∏ô‡∏¢‡πå:</strong> ${p.distKm.toFixed(2)} ‡∏Å‡∏°.</div>
          <div><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div>
        </div>
      `;
    }

    // -------------------------------------------------
    // render Top10 ‡πÉ‡∏ô panel ‡∏ã‡πâ‡∏≤‡∏¢ + strategy ‡∏™‡∏£‡∏∏‡∏õ
    // -------------------------------------------------
    function renderSideListAndStrategy(inRangePOIs, radiusKm) {
      // sort by distance
      const sorted = [...inRangePOIs].sort((a,b)=>a.distKm-b.distKm).slice(0,10);

      const topItemsDiv = document.getElementById("topItems");
      topItemsDiv.innerHTML = "";

      sorted.forEach(p => {
        // badge ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        let badgeClass = "badge-blue";
        let badgeText = "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";

        if (isCompetitorRow(p.category)) {
          badgeClass = "badge-red";
          badgeText = "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á";
        } else if (isCustomerRow(p.category)) {
          badgeClass = "badge-green";
          badgeText = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
        }

        const el = document.createElement("div");
        el.className = "poi-item";
        el.innerHTML = `
          <div class="poi-name">
            <span>${p.name || "-"}</span>
            <span class="badge ${badgeClass}">${badgeText}</span>
          </div>
          <div class="poi-meta">
            ‡∏£‡∏∞‡∏¢‡∏∞ ${p.distKm.toFixed(2)} ‡∏Å‡∏°.<br/>
            ${p.category || "-"}<br/>
            ${p.address || "-"}
          </div>
        `;
        topItemsDiv.appendChild(el);
      });

      // strategy text
      const totalCust = inRangePOIs.filter(p=>isCustomerRow(p.category)).length;
      const totalComp = inRangePOIs.filter(p=>isCompetitorRow(p.category)).length;

      let strategy = "";

      // logic ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ:
      // - ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞ > ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á => ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏≤‡∏°‡∏µ demand ‡∏™‡∏π‡∏á
      // - ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å => ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà saturated
      // - ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô=‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î => ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≥
      if (totalCust > totalComp * 1.5 && totalCust >= 3) {
        strategy += "üîé ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á ‚Üí ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏õ‡πá‡∏ô Hub ‡∏£‡∏±‡∏ö/‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏á\n";
      } else if (totalComp > totalCust && totalComp >= 3) {
        strategy += "‚ö† ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏ü‡∏Å‡∏±‡∏™\n";
      } else {
        strategy += "‚Ñπ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ñ‡∏•‡∏∞‡∏Å‡∏±‡∏ô ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î (‡∏ó‡∏≥‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡πà‡∏á‡∏£‡∏ñ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô-‡∏£‡∏≤‡∏¢‡πÇ‡∏ã‡∏ô)\n";
      }

      if (inRangePOIs.length >= 8 && radiusKm <= 10) {
        strategy += "üí∞ ‡∏à‡∏∏‡∏î‡∏õ‡πâ‡∏≠‡∏ô/‡∏à‡∏∏‡∏î‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏à‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏Å‡∏• (<10 ‡∏Å‡∏°.) ‚Üí ‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ï‡πà‡∏≥ ‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏≥‡∏£‡∏≠‡∏ö‡∏ß‡∏¥‡πà‡∏á‡∏ñ‡∏µ‡πà\n";
      } else if (radiusKm > 15) {
        strategy += "üöö ‡∏£‡∏∞‡∏¢‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á (>15 ‡∏Å‡∏°.) ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà volume ‡∏™‡∏π‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡πâ‡∏°‡∏£‡∏≠‡∏ö‡∏£‡∏ñ\n";
      }

      if (!strategy) {
        strategy = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå";
      }

      document.getElementById("strategyText").innerText = strategy;
    }

    // -------------------------------------------------
    // update ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
    // -------------------------------------------------
    function updateStats(inRangePOIs, radiusKm) {
      const totalCust = inRangePOIs.filter(p=>isCustomerRow(p.category)).length;
      const totalComp = inRangePOIs.filter(p=>isCompetitorRow(p.category)).length;
      const totalAll  = inRangePOIs.length;

      document.getElementById("radiusKMText").textContent = radiusKm;
      document.getElementById("statCustomers").textContent = totalCust;
      document.getElementById("statCompetitors").textContent = totalComp;
      document.getElementById("statTotal").textContent = totalAll;
    }

    // -------------------------------------------------
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á / ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó marker layer ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ filter
    // -------------------------------------------------
    function redrawPOILayer(radiusKm) {
      if (!map || !poiLayer) return;

      poiLayer.clearLayers();

      // filter ‡∏ï‡∏≤‡∏° focus group
      let filtered = allPOIs;
      if (currentFocus === "customer") {
        filtered = filtered.filter(p => isCustomerRow(p.category));
      } else if (currentFocus === "competitor") {
        filtered = filtered.filter(p => isCompetitorRow(p.category));
      } // "all" = ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

      // filter ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞
      const inRange = filtered.filter(p => p.distKm <= radiusKm);

      // ‡∏ß‡∏≤‡∏î marker
      inRange.forEach(p => {
        // ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        let fillColor = "#3b82f6"; // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô=‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô
        if (isCompetitorRow(p.category)) fillColor = "#ef4444"; // ‡πÅ‡∏î‡∏á = ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•
        else if (isCustomerRow(p.category)) fillColor = "#10b981"; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å

        const m = L.circleMarker([p.lat,p.lng], {
          radius: 6,
          color: "#fff",
          weight: 1.5,
          fillColor,
          fillOpacity: 0.9
        }).bindPopup(popupHTML(p));
        m.addTo(poiLayer);
      });

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ
      if (radiusCircle) {
        radiusCircle.setRadius(radiusKm * 1000);
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó panel ‡∏ã‡πâ‡∏≤‡∏¢
      updateStats(inRange, radiusKm);
      renderSideListAndStrategy(inRange, radiusKm);
    }

    // -------------------------------------------------
    // initMap
    // -------------------------------------------------
    function initMap() {
      baseStreet = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      });

      baseSat = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles ¬© Esri"
        }
      );

      map = L.map("map", {
        center: [HUB.lat, HUB.lng],
        zoom: 11,
        layers: [baseStreet]
      });

      // marker HUB
      hubLayer = L.layerGroup();
      const hubMarker = L.circleMarker([HUB.lat, HUB.lng], {
        radius: 10,
        color: "#fb923c",
        fillColor: "#f97316",
        fillOpacity: 0.9,
        weight: 2
      }).bindPopup(`
        <div class="popup-title">‚òÖ ${HUB.name}</div>
        <div class="popup-desc">
          <div><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏®‡∏π‡∏ô‡∏¢‡πå:</strong> ${HUB.address}</div>
          <div><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> ${HUB.lat}, ${HUB.lng}</div>
        </div>
      `);
      hubMarker.addTo(hubLayer);
      hubLayer.addTo(map);

      // radiusCircle
      radiusCircle = L.circle([HUB.lat, HUB.lng], {
        radius: 5000, // 5 ‡∏Å‡∏°. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        color: "#ef4444",
        weight: 1,
        fillColor: "#ef4444",
        fillOpacity: 0.08
      }).addTo(map);

      // poiLayer
      poiLayer = L.layerGroup().addTo(map);

      // layer control
      const baseMaps = {
        "‡∏ñ‡∏ô‡∏ô (OSM)": baseStreet,
        "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Esri)": baseSat
      };
      const overlayMaps = {
        "‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤": hubLayer,
        "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£": radiusCircle,
        "‡∏à‡∏∏‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢": poiLayer
      };
      L.control.layers(baseMaps, overlayMaps, {collapsed:false}).addTo(map);

      // fit view
      const bounds = L.latLngBounds([
        [HUB.lat, HUB.lng]
      ]);
      map.fitBounds(bounds.pad(0.3));
    }

    // -------------------------------------------------
    // main start
    // -------------------------------------------------
    function initApp() {
      initMap();

      // ‡πÇ‡∏´‡∏•‡∏î factories.csv
      fetch("data/factories.csv", { cache:"no-store" })
        .then(r => r.text())
        .then(text => {
          const raw = parseFactoriesCSV(text);

          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å HUB ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î
          allPOIs = raw.map(p => {
            const d = haversineKm(HUB.lat, HUB.lng, p.lat, p.lng);
            return {
              ...p,
              distKm: d
            };
          });

          // render ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          const initRadius = parseFloat(document.getElementById("radiusInput").value);
          redrawPOILayer(initRadius);
        })
        .catch(err => {
          console.error("‡πÇ‡∏´‡∏•‡∏î factories.csv ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", err);
          alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        });

      // listener radius slider
      const rInput = document.getElementById("radiusInput");
      const rVal   = document.getElementById("radiusValue");
      rInput.addEventListener("input", () => {
        const km = parseFloat(rInput.value);
        rVal.textContent = km;
        redrawPOILayer(km);
      });

      // listener radio focus
      document.querySelectorAll('input[name="focus"]').forEach(r => {
        r.addEventListener("change", (e)=>{
          currentFocus = e.target.value;
          const km = parseFloat(document.getElementById("radiusInput").value);
          redrawPOILayer(km);
        });
      });
    }

    // run
    initApp();
  </script>
</body>
</html>
