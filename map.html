<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ‚Äî ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô & ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Heatmap plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root {
      --bg-dark-900:#0f172a;
      --bg-dark-800:#1e293b;
      --bg-dark-700:#334155;
      --text-soft:#cbd5e1;
      --text-bright:#fff;
      --border-dark:#475569;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: var(--bg-dark-900);
      color: var(--text-bright);
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
    }

    header {
      background: var(--bg-dark-900);
      border-bottom: 1px solid var(--bg-dark-700);
      padding: 12px 16px;
      font-size: 14px;

      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-bright);
    }

    nav a {
      color: #94a3b8;
      margin-left: 16px;
      text-decoration: none;
      font-size: 13px;
    }
    nav a:hover {
      color: #fff;
    }
    nav a.active {
      color: #38bdf8;
      font-weight: 600;
    }

    #map-wrapper {
      position: relative;
      background: #000;
    }

    #map {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    .floating-card {
      position: absolute;
      z-index: 500;
      background: rgba(15,23,42,.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--bg-dark-700);
      border-radius: 12px;
      box-shadow: 0 24px 60px rgb(0 0 0 / .8);
      color: var(--text-soft);
      font-size: 13px;
      line-height: 1.5;
      max-width: 320px;
      min-width: 260px;
      padding: 16px 20px;
    }

    .floating-card h2 {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-bright);
      line-height: 1.4;
    }

    .floating-card .sub {
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    #panel-about {
      top: 16px;
      left: 16px;
    }

    #panel-legend {
      bottom: 16px;
      left: 16px;
    }

    .legend-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-soft);
    }

    .legend-badge {
      min-width: 22px;
      height: 22px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 22px;
      font-weight: 600;
      text-align: center;
      border:2px solid #fff;
      box-shadow:0 10px 20px rgb(0 0 0 / .5);
      color:#fff;
    }

    .badge-client    { background:#22c55e; }
    .badge-recycle   { background:#ef4444; }
    .badge-factory   { background:#3b82f6; }
    .badge-heat      {
      background: radial-gradient(circle,#ff0000 0%,rgba(0,0,0,0) 70%);
      border:none;
      box-shadow:none;
      color:transparent;
    }

    .leaflet-popup-content-wrapper {
      background:var(--bg-dark-800);
      color:var(--text-bright);
      border-radius:12px;
      border:1px solid var(--border-dark);
      box-shadow:0 24px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:var(--bg-dark-800);
      border:1px solid var(--border-dark);
    }

    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:var(--text-soft);
      line-height:1.4;
    }

    .leaflet-control-layers {
      background:var(--bg-dark-800) !important;
      border:1px solid var(--bg-dark-700) !important;
      border-radius:12px !important;
      color:#fff !important;
      box-shadow:0 24px 60px rgb(0 0 0 / .9) !important;
      font-size:13px;
      line-height:1.4;
    }
    .leaflet-control-layers-expanded {
      background:var(--bg-dark-800) !important;
      color:#fff !important;
    }
    .leaflet-control-layers-list label {
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
      font-size:13px;
      line-height:1.4;
    }
    .leaflet-control-layers-base label {
      font-weight:600;
      color:#e2e8f0;
    }

    footer {
      background:var(--bg-dark-900);
      border-top:1px solid var(--bg-dark-700);
      color:#475569;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
    }

    @media(max-width:600px){
      .floating-card {
        max-width: 90vw;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ‚Äî ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô & ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</div>
    <nav>
      <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="map.html" class="active">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
      <a href="competition.html">‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</a>
      <a href="risk.html">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</a>
    </nav>
  </header>

  <main id="map-wrapper">
    <div id="map"></div>

    <section id="panel-about" class="floating-card">
      <h2>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏°</h2>
      <div class="sub">
        ‚Ä¢ ‡∏´‡∏°‡∏∏‡∏î = ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô / ‡∏à‡∏∏‡∏î‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢<br/>
        ‚Ä¢ Heatmap = ‡πÇ‡∏ã‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô (Demand ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô)<br/><br/>
        Tips: ‡πÉ‡∏ä‡πâ‡∏ã‡∏π‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô
      </div>
    </section>

    <section id="panel-legend" class="floating-card">
      <h2>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</h2>

      <div class="legend-row">
        <div class="legend-badge badge-client">C</div>
        <div>
          ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢<br/>
          (‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å / ‡∏™‡∏∏‡∏£‡∏≤)
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-badge badge-recycle">R</div>
        <div>
          ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• / ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤<br/>
          (‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å)
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-badge badge-factory">F</div>
        <div>
          ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-badge badge-heat">‚Ä¢</div>
        <div>
          Heatmap ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô (‡∏ü‡πâ‡∏≤‚Üí‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‚Üí‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‚Üí‡∏™‡πâ‡∏°‚Üí‡πÅ‡∏î‡∏á = ‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢ ‡πÜ)
        </div>
      </div>
    </section>
  </main>

  <footer>
    ¬© ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ¬∑ Prototype ¬∑ ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏∏‡∏î/Heatmap ‡∏à‡∏≤‡∏Å CSV
  </footer>

  <script>
    // ---------------------------
    // 1) ‡∏≠‡πà‡∏≤‡∏ô CSV ‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô
    //    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö factories.csv:
    //    category,name,detail,"address with , inside",lat,lng
    //
    //    ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤‡πÉ‡∏ô address ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ "" ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV
    // ---------------------------
    function parseFactoriesCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const factories = [];

      let startIndex = 0;
      const firstLineLower = lines[0].toLowerCase();
      const hasHeader =
        firstLineLower.includes('category') ||
        firstLineLower.includes('name') ||
        firstLineLower.includes('lat');
      if (hasHeader) startIndex = 1;

      for (let i = startIndex; i < lines.length; i++) {
        let row = lines[i].trim();
        if (!row) continue;

        // address ‡πÉ‡∏ô ""
        let quotedAddress = '';
        const addrMatch = row.match(/"([^"]*)"/);
        if (addrMatch) {
          quotedAddress = addrMatch[1].trim();
          row = row.replace(addrMatch[0], '##ADDRESS_PLACEHOLDER##');
        }

        const parts = row.split(',').map(x => x.trim());
        if (parts.length < 6) continue;

        const category = parts[0] || '';
        const name = parts[1] || '';
        const detail = parts[2] || '';

        let addrRaw = parts[3];
        if (addrRaw === '##ADDRESS_PLACEHOLDER##') {
          addrRaw = quotedAddress;
        }

        const lat = parseFloat(parts[4]);
        const lng = parseFloat(parts[5]);
        if (isNaN(lat) || isNaN(lng)) continue;

        factories.push({
          category,
          name,
          detail,
          address: addrRaw,
          lat,
          lng
        });
      }

      return factories;
    }

    // ---------------------------
    // 2) ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á)
    // ---------------------------
    const redBullSite = {
      name: "‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á (‡∏à‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà)",
      address: "‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏¢‡πÉ‡∏¢‡∏£‡∏±‡∏Å ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£",
      lat: 13.565126,
      lng: 100.279895
    };

    // ---------------------------
    // 3) helper ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    // ---------------------------
    function isClientFactory(f) {
      return (
        f.category.includes("‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©") ||
        f.category.includes("‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å") ||
        f.category.includes("‡∏™‡∏∏‡∏£‡∏≤") ||
        f.detail.includes("‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©") ||
        f.detail.includes("‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å") ||
        f.detail.includes("‡∏™‡∏∏‡∏£‡∏≤")
      );
    }

    function isRecycleFactory(f) {
      return (
        f.category.includes("‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•") ||
        f.detail.includes("‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•") ||
        f.detail.includes("‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤") ||
        f.category.includes("‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤")
      );
    }

    // ---------------------------
    // 4) popup
    // ---------------------------
    function popupHTML(f) {
      return `
        <div class="popup-title">${f.name || "-"}</div>
        <div class="popup-desc">
          <div><strong>‡∏´‡∏°‡∏ß‡∏î:</strong> ${f.category || "-"}</div>
          <div><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${f.detail || "-"}</div>
          <div><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${f.address || "-"}</div>
          <div><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> ${f.lat.toFixed(5)}, ${f.lng.toFixed(5)}</div>
        </div>
      `;
    }

    // ---------------------------
    // 5) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    // ---------------------------
    let map;
    let layerRedBull;
    let layerFactories;
    let layerHeat;

    function initMap(factories) {

      // base map
      const street = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }
      );

      const satellite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles &copy; Esri"
        }
      );

      map = L.map("map", {
        center: [13.57, 100.28],
        zoom: 11,
        layers: [street]
      });

      // 5.1 ‡∏à‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á
      layerRedBull = L.layerGroup();
      const redBullMarker = L.circleMarker([redBullSite.lat, redBullSite.lng], {
        radius: 10,
        color: "#fb923c",
        fillColor: "#f97316",
        fillOpacity: 0.9,
        weight: 2
      }).bindPopup(`
        <div class="popup-title">‚òÖ ${redBullSite.name}</div>
        <div class="popup-desc">
          <div><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${redBullSite.address}</div>
          <div><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> ${redBullSite.lat}, ${redBullSite.lng}</div>
        </div>
      `);
      redBullMarker.addTo(layerRedBull);

      // 5.2 ‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô
      layerFactories = L.layerGroup();

      factories.forEach(f => {
        let fillCol = "#3b82f6"; // default ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
        let radius = 6;

        if (isClientFactory(f)) {
          fillCol = "#22c55e"; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
          radius = 7;
        } else if (isRecycleFactory(f)) {
          fillCol = "#ef4444"; // ‡πÅ‡∏î‡∏á ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á
          radius = 7;
        }

        L.circleMarker([f.lat, f.lng], {
          radius,
          color: "#fff",
          weight: 1.5,
          fillColor: fillCol,
          fillOpacity: 0.9
        })
        .bindPopup(popupHTML(f))
        .addTo(layerFactories);
      });

      // 5.3 Heatmap
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ô‡πÉ‡∏´‡πâ hotspot ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏µ
      const heatPoints = factories.map(f => {
        let w = 0.6;
        if (isRecycleFactory(f)) { w += 1.2; }
        if (isClientFactory(f))  { w += 1.0; }
        return [f.lat, f.lng, w];
      });

      layerHeat = L.heatLayer(heatPoints, {
        radius: 42,
        blur: 26,
        minOpacity: 0.25,
        max: 0.40,
        maxZoom: 17,
        // üëá ‡∏õ‡∏£‡∏±‡∏ö gradient ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô (‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô/‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á)
        gradient: {
          0.00:'#38bdf8', // ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô
          0.25:'#0ea5e9', // ‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏Å‡∏ß‡πà‡∏≤
          0.50:'#22c55e', // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
          0.70:'#fde047', // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
          0.85:'#f97316', // ‡∏™‡πâ‡∏°
          1.00:'#ef4444'  // ‡πÅ‡∏î‡∏á
        }
      });

      // 5.4 ‡πÉ‡∏™‡πà‡∏ä‡∏±‡πâ‡∏ô‡∏•‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
      layerRedBull.addTo(map);
      layerFactories.addTo(map);
      layerHeat.addTo(map);

      // 5.5 control
      const baseMaps = {
        "‡∏ñ‡∏ô‡∏ô (OSM)": street,
        "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Esri)": satellite
      };
      const overlays = {
        "‡∏´‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á": layerFactories,
        "Heatmap ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£": layerHeat,
        "‡∏à‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á": layerRedBull
      };
      L.control.layers(baseMaps, overlays, { collapsed:false }).addTo(map);

      // 5.6 ‡∏ã‡∏π‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const allLatLng = factories.map(f => [f.lat, f.lng]);
      allLatLng.push([redBullSite.lat, redBullSite.lng]);

      if (allLatLng.length > 0) {
        const bounds = L.latLngBounds(allLatLng);
        map.fitBounds(bounds.pad(0.2));
      }
    }

    // ---------------------------
    // 6) ‡πÇ‡∏´‡∏•‡∏î CSV ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°
    // ---------------------------
    fetch("data/factories.csv", { cache: "no-store" })
      .then(res => res.text())
      .then(text => {
        const factories = parseFactoriesCSV(text);
        initMap(factories);
      })
      .catch(err => {
        console.error("‡πÇ‡∏´‡∏•‡∏î factories.csv ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (factories.csv)");
      });
  </script>
</body>
</html>
