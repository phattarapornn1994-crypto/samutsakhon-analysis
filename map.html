<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>สมุทรสาคร — แผนที่โรงงาน & ความหนาแน่นประชากร</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Heatmap plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    :root {
      --bg-dark-900:#0f172a;
      --bg-dark-800:#1e293b;
      --bg-dark-700:#334155;
      --text-soft:#cbd5e1;
      --text-bright:#fff;
      --border-dark:#475569;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: var(--bg-dark-900);
      color: var(--text-bright);
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
    }

    /* ===== Top nav bar ===== */
    header {
      background: var(--bg-dark-900);
      border-bottom: 1px solid var(--bg-dark-700);
      padding: 12px 16px;
      font-size: 14px;

      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-bright);
    }

    nav a {
      color: #94a3b8;
      margin-left: 16px;
      text-decoration: none;
      font-size: 13px;
    }
    nav a:hover {
      color: #fff;
    }
    nav a.active {
      color: #38bdf8;
      font-weight: 600;
    }

    /* ===== Map wrapper ===== */
    #map-wrapper {
      position: relative;
      background: #000;
    }

    #map {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    /* ===== floating info cards ===== */

    .floating-card {
      position: absolute;
      z-index: 500;
      background: rgba(15,23,42,.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--bg-dark-700);
      border-radius: 12px;
      box-shadow: 0 24px 60px rgb(0 0 0 / .8);
      color: var(--text-soft);
      font-size: 13px;
      line-height: 1.5;
      max-width: 320px;
      min-width: 260px;
      padding: 16px 20px;
    }

    .floating-card h2 {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-bright);
      line-height: 1.4;
    }

    .floating-card .sub {
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    /* top-left panel */
    #panel-about {
      top: 16px;
      left: 16px;
    }

    /* bottom-left panel */
    #panel-legend {
      bottom: 16px;
      left: 16px;
    }

    .legend-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-soft);
    }

    .legend-badge {
      min-width: 22px;
      height: 22px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 22px;
      font-weight: 600;
      text-align: center;
      border:2px solid #fff;
      box-shadow:0 10px 20px rgb(0 0 0 / .5);
      color:#fff;
    }

    .badge-client    { background:#22c55e; } /* เขียว ลูกค้าเป้าหมาย */
    .badge-recycle   { background:#ef4444; } /* แดง คู่แข่งรีไซเคิล */
    .badge-factory   { background:#3b82f6; } /* น้ำเงิน โรงงานอื่น */
    .badge-heat      {
      background: radial-gradient(circle,#ff0000 0%,rgba(0,0,0,0) 70%);
      border:none;
      box-shadow:none;
      color:transparent;
    }

    /* ===== Leaflet popup dark theme ===== */
    .leaflet-popup-content-wrapper {
      background:var(--bg-dark-800);
      color:var(--text-bright);
      border-radius:12px;
      border:1px solid var(--border-dark);
      box-shadow:0 24px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:var(--bg-dark-800);
      border:1px solid var(--border-dark);
    }

    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:var(--text-soft);
      line-height:1.4;
    }

    /* ===== Leaflet layer control dark-ish styling ===== */
    .leaflet-control-layers {
      background:var(--bg-dark-800) !important;
      border:1px solid var(--bg-dark-700) !important;
      border-radius:12px !important;
      color:#fff !important;
      box-shadow:0 24px 60px rgb(0 0 0 / .9) !important;
      font-size:13px;
      line-height:1.4;
    }
    .leaflet-control-layers-expanded {
      background:var(--bg-dark-800) !important;
      color:#fff !important;
    }
    .leaflet-control-layers-list label {
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
      font-size:13px;
      line-height:1.4;
    }
    .leaflet-control-layers-base label {
      font-weight:600;
      color:#e2e8f0;
    }

    /* footer */
    footer {
      background:var(--bg-dark-900);
      border-top:1px solid var(--bg-dark-700);
      color:#475569;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
    }

    @media(max-width:600px){
      .floating-card {
        max-width: 90vw;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">สมุทรสาคร — แผนที่โรงงาน & ความหนาแน่นประชากร</div>
    <nav>
      <a href="index.html">หน้าแรก</a>
      <a href="map.html" class="active">แผนที่</a>
      <a href="competition.html">การแข่งขัน</a>
      <a href="risk.html">ความเสี่ยง</a>
    </nav>
  </header>

  <main id="map-wrapper">
    <div id="map"></div>

    <!-- ========== Top-left info panel ========== -->
    <section id="panel-about" class="floating-card">
      <h2>แผนที่ข้อมูลภาคสนาม</h2>
      <div class="sub">
        • หมุด = โรงงาน / จุดรีไซเคิล / ลูกค้าเป้าหมาย<br/>
        • Heatmap = โซนที่ประชากรหนาแน่น (Demand พื้นฐาน)<br/><br/>
        Tips: ใช้เครื่องมือซูมบนมุมซ้ายเพื่อซูม/ย่อบริเวณ แล้วเลือกปิด/เปิดเลเยอร์ในกล่องมุมขวาบน
      </div>
    </section>

    <!-- ========== Bottom-left legend panel ========== -->
    <section id="panel-legend" class="floating-card">
      <h2>คำอธิบายสัญลักษณ์</h2>

      <div class="legend-row">
        <div class="legend-badge badge-client">C</div>
        <div>
          ลูกค้าเป้าหมาย<br/>
          (โรงงานกระดาษ / เม็ดพลาสติก / สุรา)
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-badge badge-recycle">R</div>
        <div>
          ศูนย์รีไซเคิล / รับซื้อของเก่า<br/>
          (คู่แข่งหลัก)
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-badge badge-factory">F</div>
        <div>
          โรงงานอื่น ๆ
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-badge badge-heat">•</div>
        <div>
          Heatmap ความหนาแน่นประชากร/อุตสาหกรรม<br/>
          (สีฟ้า→เขียว→เหลือง→ส้ม→แดง = หนาแน่นสูง)
        </div>
      </div>
    </section>
  </main>

  <footer>
    © วิเคราะห์เชิงพื้นที่ สมุทรสาคร · Prototype · จุดหมุด/Heatmap จาก CSV
  </footer>

  <script>
    // ------------------------------------------------------------------
    // 1) ตัวอ่าน CSV -> Array โรงงาน
    //    ฟอร์แมตที่รองรับใน factories.csv:
    //    category,name,detail,"address with , inside",lat,lng
    //
    //    ตัวอย่าง:
    //    โรงงานรีไซเคิล,NN.copper,ศูนย์รีไซเคิล(รับซื้อของเก่า),"88/34 อำเภอเมืองสมุทรสาคร สมุทรสาคร 74000",13.63328,100.32112
    //
    //    ถ้า address มีคอมม่า , ให้ครอบด้วย "" ในไฟล์ CSV
    // ------------------------------------------------------------------
    function parseFactoriesCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const factories = [];

      // ตรวจ header แถวแรก?
      let startIndex = 0;
      const firstLineLower = lines[0].toLowerCase();
      const hasHeader =
        firstLineLower.includes('category') ||
        firstLineLower.includes('name') ||
        firstLineLower.includes('lat');
      if (hasHeader) startIndex = 1;

      for (let i = startIndex; i < lines.length; i++) {
        let row = lines[i].trim();
        if (!row) continue;

        // ดึง address ที่อยู่ใน "...."
        let quotedAddress = '';
        const addrMatch = row.match(/"([^"]*)"/);
        if (addrMatch) {
          quotedAddress = addrMatch[1].trim();
          // เอา address ชั่วคราวไปแทนด้วย placeholder
          row = row.replace(addrMatch[0], '##ADDRESS_PLACEHOLDER##');
        }

        // split คอมม่า
        const parts = row.split(',').map(x => x.trim());
        if (parts.length < 6) continue;

        const category = parts[0] || '';
        const name = parts[1] || '';
        const detail = parts[2] || '';

        // address อาจจะเป็น placeholder หรือเป็นข้อความตรง ๆ
        let addrRaw = parts[3];
        if (addrRaw === '##ADDRESS_PLACEHOLDER##') {
          addrRaw = quotedAddress;
        }

        // lat,lng
        const lat = parseFloat(parts[4]);
        const lng = parseFloat(parts[5]);
        if (isNaN(lat) || isNaN(lng)) continue;

        factories.push({
          category,
          name,
          detail,
          address: addrRaw,
          lat,
          lng
        });
      }

      return factories;
    }

    // ------------------------------------------------------------------
    // 2) จุดศูนย์กลางธุรกิจ (ลานกระทิงแดง หรือไซต์หลัก)
    // ------------------------------------------------------------------
    const redBullSite = {
      name: "ลานกระทิงแดง (จุดตั้งใหม่)",
      address: "ถนนสายใยรัก สมุทรสาคร",
      lat: 13.565126,
      lng: 100.279895
    };

    // ------------------------------------------------------------------
    // 3) Helper: ตรวจประเภท
    //    - ลูกค้าเป้าหมาย = กระดาษ / เม็ดพลาสติก / สุรา
    //    - คู่แข่ง = รีไซเคิล / รับซื้อของเก่า
    //    - ที่เหลือ = โรงงานอื่น
    // ------------------------------------------------------------------
    function isClientFactory(f) {
      return (
        f.category.includes("กระดาษ") ||
        f.category.includes("เม็ดพลาสติก") ||
        f.category.includes("สุรา") ||
        f.detail.includes("กระดาษ") ||
        f.detail.includes("เม็ดพลาสติก") ||
        f.detail.includes("สุรา")
      );
    }

    function isRecycleFactory(f) {
      return (
        f.category.includes("รีไซเคิล") ||
        f.detail.includes("รีไซเคิล") ||
        f.detail.includes("รับซื้อของเก่า") ||
        f.category.includes("รับซื้อของเก่า")
      );
    }

    // ------------------------------------------------------------------
    // 4) popup HTML
    // ------------------------------------------------------------------
    function popupHTML(f) {
      return `
        <div class="popup-title">${f.name || "-"}</div>
        <div class="popup-desc">
          <div><strong>หมวด:</strong> ${f.category || "-"}</div>
          <div><strong>รายละเอียด:</strong> ${f.detail || "-"}</div>
          <div><strong>ที่อยู่:</strong> ${f.address || "-"}</div>
          <div><strong>พิกัด:</strong> ${f.lat.toFixed(5)}, ${f.lng.toFixed(5)}</div>
        </div>
      `;
    }

    // ------------------------------------------------------------------
    // 5) main map init
    // ------------------------------------------------------------------
    let map;
    let layerRedBull;
    let layerFactories;
    let layerHeat;

    function initMap(factories) {

      // ===== base layers (ถนน / ดาวเทียม) =====
      const street = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }
      );

      const satellite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles &copy; Esri"
        }
      );

      // create map
      map = L.map("map", {
        center: [13.57, 100.28],
        zoom: 11,
        layers: [street]
      });

      // ===== 5.1 Marker ลานกระทิงแดง =====
      layerRedBull = L.layerGroup();
      const redBullMarker = L.circleMarker([redBullSite.lat, redBullSite.lng], {
        radius: 10,
        color: "#fb923c",
        fillColor: "#f97316",
        fillOpacity: 0.9,
        weight: 2
      }).bindPopup(`
        <div class="popup-title">★ ${redBullSite.name}</div>
        <div class="popup-desc">
          <div><strong>ที่อยู่:</strong> ${redBullSite.address}</div>
          <div><strong>พิกัด:</strong> ${redBullSite.lat}, ${redBullSite.lng}</div>
        </div>
      `);
      redBullMarker.addTo(layerRedBull);

      // ===== 5.2 Marker โรงงานทั้งหมด =====
      layerFactories = L.layerGroup();

      factories.forEach(f => {
        let fillCol = "#3b82f6"; // default น้ำเงิน
        let radius = 6;

        if (isClientFactory(f)) {
          fillCol = "#22c55e"; // เขียว ลูกค้าเป้าหมาย
          radius = 7;
        } else if (isRecycleFactory(f)) {
          fillCol = "#ef4444"; // แดง คู่แข่ง
          radius = 7;
        }

        const m = L.circleMarker([f.lat, f.lng], {
          radius,
          color: "#fff",
          weight: 1.5,
          fillColor: fillCol,
          fillOpacity: 0.9
        }).bindPopup(popupHTML(f));

        m.addTo(layerFactories);
      });

      // ===== 5.3 Heatmap =====
      // เราจะให้ความร้อน (weight) สูงขึ้นสำหรับจุดที่เป็น
      // - คู่แข่งรีไซเคิล (คือ demand ซาก/เศษวัสดุ ฯลฯ ที่แย่งซื้อ)
      // - ลูกค้าเป้าหมาย (คือ potential demand)
      // เพื่อให้โซนมีสีเหลือง/ส้ม/แดง โผล่เยอะขึ้น
      const heatPoints = factories.map(f => {
        let w = 0.6; // base

        if (isRecycleFactory(f)) {
          w += 1.2; // คู่แข่ง => ร้อน
        }
        if (isClientFactory(f)) {
          w += 1.0; // ลูกค้า => ก็ร้อน
        }

        return [f.lat, f.lng, w];
      });

      layerHeat = L.heatLayer(heatPoints, {
        radius: 42,        // กว้างขึ้น
        blur: 26,          // เนียนขึ้น
        minOpacity: 0.25,  // ให้เห็นแม้จาง
        max: 0.40,         // ลด max ให้สีร้อนขึ้นง่าย
        maxZoom: 17,
        gradient: {
          0.00: '#0ea5e9', // ฟ้า เย็น
          0.25:'#22c55e',  // เขียว
          0.50:'#fde047',  // เหลือง
          0.75:'#f97316',  // ส้ม
          1.00:'#ef4444'   // แดง
        }
      });

      // ===== 5.4 add default visible layers =====
      layerRedBull.addTo(map);
      layerFactories.addTo(map);
      layerHeat.addTo(map); // เริ่มเปิดไว้เลย; ถ้าอยากปิดค่าเริ่มต้น ก็อย่า addTo ตรงนี้

      // ===== 5.5 layer control =====
      const baseMaps = {
        "ถนน (OSM)": street,
        "ดาวเทียม (Esri)": satellite
      };

      const overlays = {
        "หมุดโรงงาน / ลูกค้า / คู่แข่ง": layerFactories,
        "Heatmap ประชากร": layerHeat,
        "จุดลานกระทิงแดง": layerRedBull
      };

      L.control.layers(baseMaps, overlays, { collapsed:false }).addTo(map);

      // ===== 5.6 zoom ให้พอดีกับขอบเขตข้อมูลทั้งหมด =====
      const allLatLng = factories.map(f => [f.lat, f.lng]);
      allLatLng.push([redBullSite.lat, redBullSite.lng]);

      if (allLatLng.length > 0) {
        const bounds = L.latLngBounds(allLatLng);
        map.fitBounds(bounds.pad(0.2));
      }
    }

    // ------------------------------------------------------------------
    // 6) โหลด CSV แล้วเริ่ม
    // ------------------------------------------------------------------
    fetch("data/factories.csv", { cache: "no-store" })
      .then(res => res.text())
      .then(text => {
        const factories = parseFactoriesCSV(text);
        initMap(factories);
      })
      .catch(err => {
        console.error("โหลด factories.csv ไม่ได้:", err);
        alert("โหลดข้อมูลโรงงานไม่สำเร็จ (factories.csv)");
      });
  </script>
</body>
</html>
