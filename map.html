<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แผนที่โรงงาน & ความหนาแน่นประชากร - สมุทรสาคร</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Leaflet.heat (ปลั๊กอิน Heatmap) -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background:#0f172a;
      color:#f8fafc;
      margin:0;
      padding:0;
      display:grid;
      grid-template-rows:auto 1fr auto;
      height:100vh;
    }

    header {
      background:#1e293b;
      padding:12px 16px;
      border-bottom:1px solid #334155;
      font-size:14px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      z-index:1000;
    }

    header .title-block {
      display:flex;
      flex-direction:column;
      line-height:1.3;
    }

    header .main-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
    }

    header .sub-title {
      font-size:12px;
      color:#94a3b8;
      font-weight:400;
    }

    header nav a {
      color:#94a3b8;
      margin-right:12px;
      text-decoration:none;
      font-size:13px;
    }

    header nav a:hover {
      color:#fff;
    }

    header nav a.active {
      color:#fff;
      font-weight:600;
    }

    #map-wrapper {
      position:relative;
      background:#000;
    }

    #map {
      width:100%;
      height:100%;
      min-height:400px;
      position:absolute;
      inset:0;
    }

    /* กล่องข้อมูลซ้ายบน */
    .info-panel {
      position:absolute;
      top:16px;
      left:16px;
      z-index:500;
      background:rgba(15,23,42,0.8);
      backdrop-filter:blur(8px);
      border:1px solid #334155;
      border-radius:16px;
      padding:16px 20px;
      max-width:260px;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
      font-size:13px;
      line-height:1.5;
      color:#cbd5e1;
    }

    .info-panel h2 {
      margin:0 0 8px;
      font-size:14px;
      font-weight:600;
      color:#fff;
      display:flex;
      align-items:center;
      gap:6px;
    }

    /* กล่อง legend ล่างซ้าย */
    .legend-panel {
      position:absolute;
      bottom:16px;
      left:16px;
      z-index:500;
      background:rgba(15,23,42,0.8);
      border:1px solid #334155;
      border-radius:12px;
      padding:12px 16px;
      font-size:12px;
      color:#cbd5e1;
      line-height:1.4;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
      min-width:200px;
    }

    .legend-title {
      font-size:13px;
      font-weight:600;
      color:#fff;
      margin-bottom:8px;
    }

    .legend-row {
      display:flex;
      align-items:flex-start;
      gap:8px;
      margin-bottom:6px;
      line-height:1.4;
    }

    .legend-dot {
      width:18px;
      height:18px;
      border-radius:999px;
      border:2px solid #fff;
      box-shadow:0 8px 16px rgb(0 0 0 / .5);
      font-size:11px;
      font-weight:600;
      color:#000;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* popup สวยขึ้นโทน dark */
    .leaflet-popup-content-wrapper {
      background:#1e293b;
      color:#f8fafc;
      border-radius:12px;
      border:1px solid #475569;
      box-shadow:0 20px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:#1e293b;
      border:1px solid #475569;
    }
    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:#cbd5e1;
      line-height:1.4;
    }

    /* layer control ใหม่นิดนึง */
    .leaflet-control-layers {
      background:#1e293b !important;
      border:1px solid #334155 !important;
      border-radius:12px !important;
      color:#fff !important;
      box-shadow:0 20px 60px rgb(0 0 0 / .8) !important;
      font-size:12px;
      line-height:1.4;
    }
    .leaflet-control-layers-expanded {
      background:#1e293b !important;
      color:#fff !important;
    }
    .leaflet-control-layers-list label {
      color:#cbd5e1;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }

    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }
  </style>
</head>
<body>
  <header>
    <div class="title-block">
      <div class="main-title">สมุทรสาคร — แผนที่โรงงาน & ความหนาแน่นประชากร</div>
      <div class="sub-title">
        หมุดโรงงาน, ชั้น Heatmap ตามจำนวนประชากร, เลือกชั้นข้อมูลได้
      </div>
    </div>
    <nav>
      <a href="index.html">หน้าแรก</a>
      <a href="map.html" class="active">แผนที่</a>
      <a href="competition.html">การแข่งขัน</a>
      <a href="risk.html">ความเสี่ยง</a>
    </nav>
  </header>

  <section id="map-wrapper">
    <div id="map"></div>

    <!-- กล่องข้อมูลบนซ้าย -->
    <div class="info-panel">
      <h2>แผนที่ข้อมูลภาคสนาม</h2>
      <div>
        - หมุด = โรงงาน / จุดรีไซเคิล / ลูกค้าเป้าหมาย<br/>
        - Heatmap = โซนประชากรหนาแน่น (Demand พื้นฐาน)<br/><br/>
        <b>Tips:</b> ใช้เครื่องมือมุมขวาบนเพื่อโชว์/ซ่อนชั้นข้อมูล เช่น Heatmap หรือหมุด
      </div>
    </div>

    <!-- Legend ล่างซ้าย -->
    <div class="legend-panel">
      <div class="legend-title">คำอธิบายสัญลักษณ์</div>

      <div class="legend-row">
        <div class="legend-dot" style="background:#22c55e; border-color:#14532d; color:#000;">C</div>
        <div>
          ลูกค้าเป้าหมาย<br/>
          (โรงงานกระดาษ / เม็ดพลาสติก / สุรา)
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-dot" style="background:#ef4444; border-color:#450a0a; color:#fff;">R</div>
        <div>
          คู่แข่งรีไซเคิล / รับซื้อของเก่า
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-dot" style="background:#94a3b8; border-color:#1e293b; color:#000;">F</div>
        <div>
          โรงงานอื่น ๆ
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-dot" style="background:radial-gradient(circle at center, #ffffff 0%, #ff0000 60%, #000000 100%); border-color:#000; color:#000;"> </div>
        <div>
          Heatmap ความหนาแน่นประชากร<br/>
          (สว่าง/แดง = หนาแน่น)
        </div>
      </div>
    </div>
  </section>

  <footer>
    © สมุทรสาคร spatial demo | client-side only
  </footer>

  <script>
    //---------------------------------
    // 1) ตั้งค่าแผนที่ + base layers
    //---------------------------------
    const map = L.map('map', {
      center: [13.57, 100.28], // กลางสมุทรสาครประมาณ ๆ
      zoom: 11,
      zoomControl: true
    });

    // แผนที่ถนน
    const streetLayer = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {
        maxZoom: 20,
        attribution: '© OpenStreetMap contributors'
      }
    ).addTo(map); // default on

    // แผนที่ดาวเทียม (ใช้ Esri WorldImagery)
    const satelliteLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 20,
        attribution: 'Tiles © Esri'
      }
    );

    //---------------------------------
    // 2) ตัวเก็บชั้นข้อมูล overlay
    //---------------------------------
    const markerLayerGroup = L.layerGroup();     // หมุดโรงงาน
    const heatLayerGroup = L.layerGroup();       // Heatmap
    // เราจะเติม heat layer ด้านในทีหลัง

    //---------------------------------
    // 3) Helper: วาดหมุดตามประเภท
    //---------------------------------
    function isCustomerCategory(cat){
      if(!cat) return false;
      return (
        cat.includes("โรงงานกระดาษ") ||
        cat.includes("เม็ดพลาสติก")  ||
        cat.includes("พลาสติก")      || // เผื่อเขียนย่อ
        cat.includes("สุรา")          ||
        cat.includes("เหล้า")         ||
        cat.includes("เครื่องดื่มแอลกอฮอล์")
      );
    }

    function isCompetitorCategory(cat){
      if(!cat) return false;
      return (
        cat.includes("รีไซเคิล") ||
        cat.includes("รับซื้อของเก่า") ||
        cat.includes("ศูนย์รีไซเคิล")
      );
    }

    function makeFactoryMarker(lat, lng, row){
      // สีหมุด
      let fill = "#94a3b8"; // โรงงานทั่วไป = เทา
      let textLetter = "F";

      if(isCustomerCategory(row.category)){
        fill = "#22c55e"; // เขียว ลูกค้า
        textLetter = "C";
      } else if(isCompetitorCategory(row.category)){
        fill = "#ef4444"; // แดง คู่แข่ง
        textLetter = "R";
      }

      // ใช้ DivIcon เพื่อทำหมุดกลมกำหนดสีเอง
      const iconHtml = `
        <div style="
          width:22px;
          height:22px;
          background:${fill};
          border-radius:999px;
          border:2px solid #000;
          box-shadow:0 10px 20px rgb(0 0 0 / .7);
          color:#000;
          font-size:11px;
          font-weight:600;
          display:flex;
          align-items:center;
          justify-content:center;
        ">
          ${textLetter}
        </div>
      `;

      const divIcon = L.divIcon({
        className: "",
        html: iconHtml,
        iconSize: [22,22],
        iconAnchor: [11,11],
        popupAnchor: [0,-10]
      });

      const marker = L.marker([lat,lng], { icon: divIcon });

      // popup detail
      const popupHtml = `
        <div class="popup-title">${row.name || "(ไม่มีชื่อโรงงาน)"}</div>
        <div class="popup-desc">
          <b>หมวด:</b> ${row.category || "-"}<br/>
          <b>ที่อยู่:</b> ${row.address || "-"}<br/>
          <b>พิกัด:</b> ${lat.toFixed(5)}, ${lng.toFixed(5)}
        </div>
      `;

      marker.bindPopup(popupHtml);
      return marker;
    }

    //---------------------------------
    // 4) โหลด factories.csv -> วางหมุด
    //---------------------------------
    function parseCSV(text){
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",").map(h=>h.trim());

      return lines.slice(1).map(line => {
        // split แบบง่าย: ต้องไม่มีคอมม่าในช่อง
        const cols = line.split(",").map(x=>x.trim());
        const obj = {};
        headers.forEach((h,i)=>{
          obj[h] = cols[i] || "";
        });
        return obj;
      });
    }

    fetch("../data/factories.csv")
      .then(r => r.text())
      .then(txt => {
        const rows = parseCSV(txt);

        rows.forEach(row => {
          const lat = parseFloat(row.lat);
          const lng = parseFloat(row.lng);
          if(isNaN(lat) || isNaN(lng)) return;

          const marker = makeFactoryMarker(lat, lng, row);
          marker.addTo(markerLayerGroup);
        });
      })
      .catch(err => {
        console.error("โหลด factories.csv ไม่ได้:", err);
      });

    //---------------------------------
    // 5) โหลด subdistricts.csv -> heatmap
    //---------------------------------
    // เราจะสร้าง heatData = [[lat,lng,intensity], ...]
    // intensity = scale ประชากร / 50000 (จำกัด max=1)
    fetch("../data/subdistricts.csv")
      .then(r => r.text())
      .then(txt => {
        const rows = parseCSV(txt);

        const heatData = [];
        rows.forEach(r => {
          const lat = parseFloat(r.lat);
          const lng = parseFloat(r.lng);
          const pop = parseFloat(r.population);

          if(isNaN(lat) || isNaN(lng) || isNaN(pop)) return;

          // normalize ความหนาแน่น
          let intensity = pop / 50000;
          if(intensity > 1) intensity = 1;
          if(intensity < 0.05) intensity = 0.05; // อย่าให้หายไปเลย

          heatData.push([lat, lng, intensity]);
        });

        if(heatData.length){
          const heatLayer = L.heatLayer(heatData, {
            radius: 30,
            blur: 25,
            maxZoom: 17
          });
          heatLayer.addTo(heatLayerGroup);
        }
      })
      .catch(err => {
        console.error("โหลด subdistricts.csv ไม่ได้:", err);
      });

    //---------------------------------
    // 6) เพิ่ม layer control (มุมขวาบน)
    //---------------------------------
    const baseLayers = {
      "ถนน (OSM)": streetLayer,
      "ดาวเทียม (Esri)": satelliteLayer
    };

    const overlays = {
      "หมุดโรงงาน / ลูกค้า / คู่แข่ง": markerLayerGroup,
      "Heatmap ประชากร": heatLayerGroup
    };

    L.control.layers(baseLayers, overlays, { collapsed:false }).addTo(map);

    // เปิด overlay เริ่มต้น
    markerLayerGroup.addTo(map);
    heatLayerGroup.addTo(map);

    //---------------------------------
    // 7) ปรับขอบเขตเริ่มต้น (fitBounds)
    //---------------------------------
    // เราจะขยาย map ให้ครอบสมุทรสาครประมาณนี้
    // ถ้าคุณอยาก auto-fit จากจุดจริงของโรงงาน ให้ย้าย fitBounds ไปหลังโหลด factories แล้วคำนวณ bounds
    const approxBounds = L.latLngBounds(
      [13.45, 100.05], // SW
      [13.80, 100.50]  // NE
    );
    map.fitBounds(approxBounds);
  </script>
</body>
</html>
