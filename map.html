<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà - ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Leaflet.heat (‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏≠‡∏¥‡∏ô Heatmap - ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î) -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
    }

    header {
      background: #1e293b;
      padding: 12px 16px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      line-height: 1.3;
    }

    header .main-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    header .sub-title {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 400;
    }

    header nav a {
      color: #94a3b8;
      margin-right: 12px;
      text-decoration: none;
      font-size: 13px;
    }
    header nav a:hover {
      color: #fff;
    }

    #map-wrapper {
      position: relative;
      background: #000;
    }

    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      position: absolute;
      inset: 0;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á info ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô */
    .info-panel {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 500;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 16px 20px;
      max-width: 260px;
      box-shadow: 0 20px 60px rgb(0 0 0 / .7);
      font-size: 13px;
      line-height: 1.5;
      color: #cbd5e1;
    }

    .info-panel h2 {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á legend ‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ */
    .legend-panel {
      position: absolute;
      bottom: 16px;
      left: 16px;
      z-index: 500;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 12px;
      color: #cbd5e1;
      line-height: 1.4;
      box-shadow: 0 20px 60px rgb(0 0 0 / .7);
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .legend-dot {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      box-shadow: 0 8px 16px rgb(0 0 0 / .5);
      font-weight: 600;
      color: #fff;
    }

    /* footer */
    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }

    /* popup theme ‡∏°‡∏∑‡∏î‡πÜ */
    .leaflet-popup-content-wrapper {
      background:#1e293b;
      color:#f8fafc;
      border-radius:12px;
      border:1px solid #475569;
      box-shadow:0 20px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:#1e293b;
      border:1px solid #475569;
    }
    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:#cbd5e1;
      line-height:1.4;
    }

    /* layer control ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏° */
    .leaflet-control-layers {
      background:#1e293b !important;
      border:1px solid #334155 !important;
      border-radius:12px !important;
      color:#fff !important;
      box-shadow:0 20px 60px rgb(0 0 0 / .8) !important;
      font-size:12px;
      line-height:1.4;
    }
    .leaflet-control-layers-expanded {
      background:#1e293b !important;
      color:#fff !important;
    }
    .leaflet-control-layers-list label {
      color:#cbd5e1;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
  </style>
</head>

<body>
  <header>
    <div class="title-block">
      <div class="main-title">‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ‚Äî ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
      <div class="sub-title">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£ / ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• / ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à</div>
    </div>
    <nav>
      <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="map.html" style="color:#fff;">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
      <a href="competition.html">‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</a>
      <a href="risk.html">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</a>
    </nav>
  </header>

  <div id="map-wrapper">
    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ -->
    <div class="info-panel">
      <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà üó∫</h2>
      <div>
        ‚Ä¢ ‡∏ß‡∏á‡∏™‡∏µ‡∏ü‡πâ‡∏≤ = ‡∏ï‡∏≥‡∏ö‡∏• (‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏á ‚âà ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£)<br/>
        ‚Ä¢ ‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏î‡∏á = ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• / ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á<br/>
        ‚Ä¢ ‡∏™‡∏•‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: ‡∏ñ‡∏ô‡∏ô / ‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°<br/>
      </div>
    </div>

    <!-- ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ -->
    <div class="legend-panel">
      <div class="legend-row">
        <span class="legend-dot" style="background:#0ea5e9;border-color:#38bdf8;">‡∏ä</span>
        <span>‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (‡∏ï‡∏≥‡∏ö‡∏•) + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</span>
      </div>
      <div class="legend-row">
        <span class="legend-dot" style="background:#ef4444;border-color:#f87171;">‡∏Ñ</span>
        <span>‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)</span>
      </div>
    </div>

    <!-- ‡∏ï‡∏±‡∏ß‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
    <div id="map"></div>
  </div>

  <footer>
    ¬© ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ data demo | Leaflet + CSV | client-side only
  </footer>

  <script>
    // -----------------------
    // 0) utils: parser CSV ‡πÄ‡∏ö‡∏≤‡πÜ
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó, ‡∏à‡∏≥‡∏Å‡∏±‡∏î")
    // ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ parser ‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô (split ‡∏î‡πâ‡∏ß‡∏¢ regex / handle quotes)
    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ comma ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô lat,lng ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß)
    // -----------------------
    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");

      const rows = lines.slice(1).map(line => {
        const cols = line.split(",");
        const obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = (cols[i] || "").trim();
        });
        return obj;
      });

      return rows;
    }

    // -----------------------
    // 1) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Leaflet
    // -----------------------
    const map = L.map("map").setView([13.55, 100.28], 11);

    // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏ô‡∏ô OSM
    const streetLayer = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 20,
        attribution: "&copy; OpenStreetMap contributors"
      }
    ).addTo(map);

    // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° Esri
    const satelliteLayer = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 20,
        attribution: "Tiles &copy; Esri"
      }
    );

    // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const subdistrictLayer = L.layerGroup().addTo(map); // ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏ï‡∏≥‡∏ö‡∏• / ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
    const factoryLayer = L.layerGroup().addTo(map);     // ‡∏´‡∏°‡∏∏‡∏î‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)

    // -----------------------
    // 2) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡∏ö‡∏•/‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£
    //    ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á header: district_th,subdistrict_th,subdistrict_en,population,lat,lng
    // -----------------------
    fetch("../data/subdistricts.csv")
      .then(res => res.text())
      .then(csvText => {
        const data = parseCSV(csvText);

        data.forEach(row => {
          const lat = parseFloat(row.lat);
          const lng = parseFloat(row.lng);
          const pop = Number(row.population);

          if (isNaN(lat) || isNaN(lng)) return;

          // popup
          const popupHTML = `
            <div class="popup-title">
              ${row.subdistrict_th} (${row.subdistrict_en})
            </div>
            <div class="popup-desc">
              ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: ${row.district_th}<br/>
              ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£: ${pop.toLocaleString("th-TH")} ‡∏Ñ‡∏ô
            </div>
          `;

          // radius ‡πÄ‡∏°‡∏ï‡∏£‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏¢‡∏¥‡πà‡∏á‡∏Ñ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏ß‡∏á‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà)
          const radiusMeters = 50 + (pop / 1000) * 5;

          const circle = L.circle([lat, lng], {
            radius: radiusMeters,
            color: "#38bdf8",     // ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô
            weight: 1,
            fillColor: "#0ea5e9", // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ü‡πâ‡∏≤
            fillOpacity: 0.4
          });

          circle.bindPopup(popupHTML);
          circle.addTo(subdistrictLayer);
        });
      })
      .catch(err => {
        console.error("‡πÇ‡∏´‡∏•‡∏î subdistricts.csv ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
      });

    // -----------------------
    // 3) ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• (‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á)
    //    ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á header ‡πÄ‡∏ä‡πà‡∏ô:
    //    category,name,type,address,lat,lng
    //    ‡πÅ‡∏•‡∏∞ lat,lng ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    // -----------------------
    fetch("../data/factories.csv")
      .then(res => res.text())
      .then(csvText => {
        const rows = parseCSV(csvText);

        // custom icon ‡∏™‡∏µ‡πÅ‡∏î‡∏á
        const redIcon = L.icon({
          iconUrl:
            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
          iconSize:     [25, 41],
          iconAnchor:   [12, 41],
          popupAnchor:  [1, -34],
          shadowUrl:
            "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
          shadowSize:   [41, 41],
          shadowAnchor: [12, 41]
        });

        rows.forEach(r => {
          const lat = parseFloat(r.lat);
          const lng = parseFloat(r.lng);
          if (isNaN(lat) || isNaN(lng)) return;

          // popup ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô
          const popupHTML = `
            <div class="popup-title">
              ${r.name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)"}
            </div>
            <div class="popup-desc">
              ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${r.category || "-"}<br/>
              ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${r.type || "-"}<br/>
              ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${r.address || "-"}<br/>
              ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(5)}, ${lng.toFixed(5)}
            </div>
          `;

          const marker = L.marker([lat, lng], { icon: redIcon });
          marker.bindPopup(popupHTML);
          marker.addTo(factoryLayer);
        });
      })
      .catch(err => {
        console.error("‡πÇ‡∏´‡∏•‡∏î factories.csv ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
      });

    // -----------------------
    // 4) Layer control: ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏•‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
    // -----------------------
    const baseMaps = {
      "‡∏ñ‡∏ô‡∏ô (OSM)": streetLayer,
      "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Esri)": satelliteLayer
    };

    const overlayMaps = {
      "‡∏ä‡∏∏‡∏°‡∏ä‡∏ô / ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£ (‡∏ï‡∏≥‡∏ö‡∏•)": subdistrictLayer,
      "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á ‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•": factoryLayer
      // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ heatmapLayer ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    };

    L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);
  </script>
</body>
</html>
