<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>วิเคราะห์ความเสี่ยงพื้นที่ - สมุทรสาคร</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background:#0f172a;
      color:#f8fafc;
      margin:0;
      padding:0;
      display:grid;
      grid-template-rows:auto 1fr auto;
      height:100vh;
    }

    header {
      background:#1e293b;
      padding:12px 16px;
      border-bottom:1px solid #334155;
      font-size:14px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    header nav a {
      color:#94a3b8;
      margin-right:12px;
      text-decoration:none;
      font-size:13px;
    }
    header nav a:hover { color:#fff; }

    main {
      display:grid;
      grid-template-columns: minmax(260px,320px) 1fr;
      gap:0;
      min-height:0;
    }

    /* แผงสรุปความเสี่ยง */
    .risk-panel {
      background:#1e293b;
      border-right:1px solid #334155;
      padding:16px;
      font-size:13px;
      line-height:1.5;
      overflow-y:auto;
    }

    .risk-panel h2 {
      margin:0 0 12px;
      font-size:14px;
      font-weight:600;
      color:#fff;
    }

    .risk-block {
      background:#0f172a;
      border:1px solid #334155;
      border-radius:12px;
      padding:12px 14px;
      margin-bottom:12px;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
    }

    .risk-block h3 {
      margin:0 0 6px;
      font-size:13px;
      font-weight:600;
      color:#fff;
    }
    .risk-block p {
      margin:0;
      font-size:12px;
      color:#cbd5e1;
      line-height:1.4;
    }

    /* แผนที่ */
    #map-wrapper {
      position:relative;
      background:#000;
    }
    #map {
      position:absolute;
      inset:0;
      min-height:400px;
    }

    .radius-box {
      position:absolute;
      top:16px;
      right:16px;
      z-index:500;
      background:rgba(15,23,42,.9);
      border:1px solid #334155;
      border-radius:12px;
      padding:12px;
      font-size:12px;
      color:#cbd5e1;
      min-width:200px;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
    }

    .radius-box label {
      font-size:12px;
      color:#94a3b8;
      display:block;
      margin-bottom:4px;
    }
    .radius-box input[type="range"] {
      width:100%;
      background:#1e293b;
      border:1px solid #475569;
      border-radius:8px;
      color:#fff;
    }
    .radius-box .readout {
      text-align:right;
      color:#fff;
      font-weight:500;
    }

    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }

    .leaflet-popup-content-wrapper {
      background:#1e293b;
      color:#f8fafc;
      border-radius:12px;
      border:1px solid #475569;
      box-shadow:0 20px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:#1e293b;
      border:1px solid #475569;
    }
    .popup-title {font-size:14px;font-weight:600;color:#fff;margin-bottom:4px;line-height:1.4;}
    .popup-desc {font-size:12px;color:#cbd5e1;line-height:1.4;}
  </style>
</head>
<body>
  <header>
    <div style="color:#fff;font-weight:600;font-size:13px;">
      วิเคราะห์ความเสี่ยงพื้นที่ – สมุทรสาคร
    </div>
    <nav>
      <a href="index.html">หน้าหลัก</a>
      <a href="map.html">แผนที่รวม</a>
      <a href="population.html">ประชากร</a>
      <a href="competition.html">การแข่งขัน</a>
      <a style="color:#fff;font-weight:600;" href="risk.html">ความเสี่ยง</a>
    </nav>
  </header>

  <main>
    <!-- panel -->
    <aside class="risk-panel">
      <h2>สรุปความเสี่ยง (เบื้องต้น)</h2>

      <div class="risk-block">
        <h3>การแข่งขันสูง</h3>
        <p>
          จำนวนโรงงานรีไซเคิลในรัศมี <span id="riskCompetitorRadius">-</span> กม.
          รอบลานกระทิงแดง:
          <span id="riskCompetitorCount">-</span> แห่ง
        </p>
        <p style="margin-top:6px;">
          ถ้าตัวเลขสูง = มีคู่แข่งรับวัสดุรีไซเคิล/ของเสียใกล้จุดปฏิบัติการเรา
        </p>
      </div>

      <div class="risk-block">
        <h3>โอกาสลูกค้า</h3>
        <p>
          จำนวนโรงงานประเภทอาหาร/เครื่องดื่ม/แปรรูป
          ในรัศมีเดียวกัน:
          <span id="riskFoodCount">-</span> แห่ง
        </p>
        <p style="margin-top:6px;">
          ถ้าตัวเลขสูง = มี demand ของเสียบรรจุภัณฑ์ อาหารเหลือ เศษวัตถุดิบ ฯลฯ
        </p>
      </div>

      <div class="risk-block">
        <h3>หมายเหตุ</h3>
        <p>
          หน้านี้ยังเป็น baseline risk dashboard.<br/>
          ขั้นต่อไป: จะเพิ่ม heatmap ความหนาแน่นคู่แข่ง,
          ประชากรแรงงานกลางวัน,
          และ zone มลภาวะที่อาจโดนร้องเรียน.
        </p>
      </div>
    </aside>

    <!-- map -->
    <section id="map-wrapper">
      <div id="map"></div>

      <div class="radius-box">
        <label for="riskRadiusInput">รัศมีประเมินความเสี่ยง (เมตร)</label>
        <input id="riskRadiusInput" type="range" min="1000" max="7000" step="1000" value="3000"/>
        <div class="readout"><span id="riskRadiusLabel">3,000 m</span></div>
      </div>
    </section>
  </main>

  <footer>
    © สมุทรสาคร spatial analysis · risk view
  </footer>

  <script>
    const hubLat = 13.565126;
    const hubLng = 100.279895;
    const hubLatLng = [hubLat, hubLng];

    const map = L.map("map", {
      center: hubLatLng,
      zoom: 12,
      scrollWheelZoom: true
    });

    const street = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 20, attribution:"© OpenStreetMap" }
    ).addTo(map);

    const satellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20, attribution:"Tiles © Esri" }
    );

    L.control.layers(
      { "ถนน (OSM)": street, "ดาวเทียม": satellite },
      null,
      { position:"topleft" }
    ).addTo(map);

    // hub
    const hubMarker = L.circleMarker(hubLatLng, {
      radius:8,
      color:"#ff0000",
      fillColor:"#ff4d4d",
      fillOpacity:1,
      weight:2
    })
    .addTo(map)
    .bindPopup(
      `<div class="popup-title">ลานกระทิงแดง (Hub)</div>
       <div class="popup-desc">
        จุดปฏิบัติการหลัก / ถนนสายใยรัก<br/>
        ${hubLat.toFixed(6)}, ${hubLng.toFixed(6)}
       </div>`
    );

    let radiusCircle = null;
    let allFactory = [];
    let factoryMarkers = [];

    function drawCircle(rm){
      if(radiusCircle){ map.removeLayer(radiusCircle); }
      radiusCircle = L.circle(hubLatLng,{
        radius:rm,
        color:"#ff0000",
        weight:2,
        fillColor:"#ff0000",
        fillOpacity:0.06
      }).addTo(map);
    }

    function distanceMeters(lat1,lng1,lat2,lng2){
      const R=6371000;
      const toRad=d=>d*Math.PI/180;
      const dLat=toRad(lat2-lat1);
      const dLng=toRad(lng2-lng1);
      const a=Math.sin(dLat/2)**2+
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
        Math.sin(dLng/2)**2;
      const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }

    function buildMarkers(){
      factoryMarkers.forEach(m=>map.removeLayer(m.marker));
      factoryMarkers=[];

      allFactory.forEach(f=>{
        if(!f.lat || !f.lng) return;
        const marker=L.circleMarker([f.lat,f.lng],{
          radius:5,
          color:"#38bdf8",
          fillColor:"#38bdf8",
          fillOpacity:0.9,
          weight:2
        }).bindPopup(
          `<div class="popup-title">${f.name}</div>
           <div class="popup-desc">
             ${f.category}<br/>
             ${f.desc||""}
           </div>`
        );
        marker.addTo(map);
        factoryMarkers.push({marker:marker,data:f});
      });
    }

    function updateRisk(){
      const r = parseInt(document.getElementById("riskRadiusInput").value,10);

      drawCircle(r);

      let competitorIn=0;
      let foodIn=0;

      factoryMarkers.forEach(obj=>{
        const {marker,data}=obj;
        const d=distanceMeters(hubLat,hubLng,data.lat,data.lng);
        const inZone=d<=r;

        // คู่แข่ง = โรงงานรีไซเคิล
        if(data.category==="โรงงานรีไซเคิล"){
          marker.setStyle({
            radius:6,
            color: inZone ? "#ff0000" : "#f87171",
            fillColor: inZone ? "#ff0000" : "#f87171",
            fillOpacity:1,
            weight:2
          });
          if(inZone) competitorIn++;
        } else if(
          data.category==="โรงงานอาหารและเครื่องดื่ม" ||
          data.category==="โรงงานอาหารสัตว์"
        ){
          marker.setStyle({
            radius:6,
            color: inZone ? "#38bdf8" : "#93c5fd",
            fillColor: inZone ? "#38bdf8" : "#93c5fd",
            fillOpacity:1,
            weight:2
          });
          if(inZone) foodIn++;
        } else {
          marker.setStyle({
            radius:4,
            color:"#64748b",
            fillColor:"#64748b",
            fillOpacity:0.7,
            weight:1
          });
        }
      });

      // อัปเดตตัวเลขใน panel
      document.getElementById("riskCompetitorRadius").textContent = (r/1000).toFixed(1);
      document.getElementById("riskCompetitorCount").textContent = competitorIn;
      document.getElementById("riskFoodCount").textContent = foodIn;

      // อัปเดต label slider
      document.getElementById("riskRadiusLabel").textContent =
        r.toLocaleString("en-US")+" m";
    }

    // โหลดข้อมูลโรงงาน
    fetch("../data/factories.json")
      .then(res=>res.json())
      .then(json=>{
        allFactory=json;
        buildMarkers();
        updateRisk();
      })
      .catch(err=>console.error("โหลด factories.json ไม่ได้",err));

    // event ของ slider
    document.getElementById("riskRadiusInput").addEventListener("input",()=>{
      updateRisk();
    });

    // set เริ่มต้น
    document.getElementById("riskRadiusLabel").textContent =
      parseInt(document.getElementById("riskRadiusInput").value,10)
      .toLocaleString("en-US")+" m";
  </script>
</body>
</html>
