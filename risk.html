<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà - ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£</title>

  <!-- Leaflet ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏ï‡πà‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background:#0f172a;
      color:#f8fafc;
      margin:0;
      padding:0;
      display:grid;
      grid-template-rows:auto 1fr auto;
      min-height:100vh;
    }

    header {
      background:#1e293b;
      padding:12px 16px;
      border-bottom:1px solid #334155;
      font-size:14px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    header .title-block {
      display:flex;
      flex-direction:column;
      line-height:1.3;
    }
    header .main-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
    }
    header .sub-title {
      font-size:12px;
      color:#94a3b8;
      font-weight:400;
    }
    header nav a {
      color:#94a3b8;
      margin-right:12px;
      text-decoration:none;
      font-size:13px;
    }
    header nav a:hover {
      color:#fff;
    }
    header nav a.active {
      color:#fff;
      font-weight:600;
    }

    main {
      padding:16px;
      max-width:1200px;
      width:100%;
      margin:0 auto;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á summary */
    .score-summary {
      background:rgba(15,23,42,0.8);
      border:1px solid #334155;
      border-radius:16px;
      padding:16px 20px;
      margin-bottom:16px;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
      display:grid;
      gap:12px;
    }
    .summary-row {
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
    }
    .summary-left {
      flex:1 1 200px;
    }
    .summary-title {
      font-size:15px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:8px;
      line-height:1.4;
    }
    .summary-desc {
      color:#94a3b8;
      font-size:13px;
      line-height:1.5;
    }

    .summary-right {
      flex:0 0 auto;
      min-width:200px;
      background:#1e293b;
      border:1px solid #475569;
      border-radius:12px;
      padding:12px 16px;
      text-align:center;
    }
    .score-number {
      font-size:28px;
      font-weight:600;
      line-height:1.2;
      color:#fff;
    }
    .score-risktext {
      font-size:14px;
      font-weight:600;
      margin-top:4px;
      line-height:1.4;
    }
    .score-hint {
      font-size:12px;
      color:#94a3b8;
      line-height:1.4;
      margin-top:6px;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏• */
    .table-wrap {
      background:#1e293b;
      border:1px solid #334155;
      border-radius:16px;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
      overflow-x:auto;
    }
    table {
      width:100%;
      border-collapse:collapse;
      min-width:800px;
      font-size:13px;
      color:#cbd5e1;
    }

    thead {
      background:#334155;
      color:#fff;
      text-align:left;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    thead th {
      padding:10px 12px;
      white-space:nowrap;
      border-bottom:1px solid #475569;
    }

    tbody tr:nth-child(even){
      background:#1e2536;
    }
    tbody tr:nth-child(odd){
      background:#1e293b;
    }
    tbody td {
      padding:10px 12px;
      vertical-align:top;
      border-bottom:1px solid #334155;
      line-height:1.4;
    }
    tbody td.small {
      font-size:12px;
      color:#94a3b8;
    }

    .risk-badge {
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 8px;
      font-size:12px;
      font-weight:600;
      line-height:1.4;
      min-width:70px;
      justify-content:center;
      color:#000;
    }

    /* footer */
    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }

    /* legend ‡∏™‡∏µ */
    .legend-box {
      display:flex;
      flex-wrap:wrap;
      gap:8px 16px;
      margin-top:8px;
      font-size:12px;
      line-height:1.4;
      color:#94a3b8;
    }
    .legend-item {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .legend-dot {
      width:16px;
      height:16px;
      border-radius:4px;
      font-weight:600;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#000;
    }
  </style>
</head>

<body>
  <header>
    <div class="title-block">
      <div class="main-title">‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ‚Äî ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
      <div class="sub-title">
        ‡∏î‡∏π Demand ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ vs ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• ‡∏£‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≥‡∏ö‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÇ‡∏ã‡∏ô‡∏™‡∏µ üü¢üü°üü†üî¥
      </div>
    </div>
    <nav>
      <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="map.html">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
      <a href="competition.html">‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</a>
      <a href="risk.html" class="active">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</a>
    </nav>
  </header>

  <main>
    <!-- SUMMARY TOP CARD -->
    <section class="score-summary">
      <div class="summary-row">
        <div class="summary-left">
          <div class="summary-title">
            ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
            <span id="overallColorDot" style="display:inline-flex;width:16px;height:16px;border-radius:4px;border:1px solid #000;"></span>
          </div>
          <div class="summary-desc">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏π‡∏™‡∏≠‡∏á‡∏°‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≥‡∏ö‡∏• (‡∏£‡∏±‡∏®‡∏°‡∏µ ~3 ‡∏Å‡∏°.):
            <br/>
            1) ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û = ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å / ‡∏™‡∏∏‡∏£‡∏≤
            <br/>
            2) ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á = ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•
            <br/><br/>
            ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á 0 (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) ‚Üí 100 (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á)
            ‡πÇ‡∏î‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÅ‡∏ï‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢"
          </div>

          <div class="legend-box">
            <div class="legend-item">
              <span class="legend-dot" style="background:#22c55e;">üü¢</span>
              <span>‡∏ï‡πà‡∏≥ (&le;25)</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot" style="background:#eab308;">üü°</span>
              <span>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (&le;50)</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot" style="background:#f97316;">üü†</span>
              <span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á (&le;75)</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot" style="background:#ef4444;">üî¥</span>
              <span>‡∏™‡∏π‡∏á (&gt;75)</span>
            </div>
          </div>
        </div>

        <div class="summary-right">
          <div class="score-number" id="overallScore">--</div>
          <div class="score-risktext" id="overallLabel">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</div>
          <div class="score-hint">
            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•
          </div>
        </div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th>
            <th>‡∏ï‡∏≥‡∏ö‡∏•</th>
            <th>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</th>
            <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ (‚â§3 ‡∏Å‡∏°.)</th>
            <th>‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ (‚â§3 ‡∏Å‡∏°.)</th>
            <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
            <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
          </tr>
        </thead>
        <tbody id="riskTableBody">
          <!-- ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </tbody>
      </table>
    </section>
  </main>

  <footer>
    ¬© ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ risk model demo | client-side only
  </footer>

  <script>
    // -----------------------------
    // 1) helpers
    // -----------------------------

    // CSV parser ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ: ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á
    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const headers = lines[0].split(",");

      return lines.slice(1).map(line => {
        const cols = line.split(",");
        const obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = (cols[i] || "").trim();
        });
        return obj;
      });
    }

    // haversine distance (km)
    function distanceKm(lat1, lon1, lat2, lon2){
      const R = 6371; // km
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);

      const a =
        Math.sin(dLat/2)*Math.sin(dLat/2) +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)*Math.sin(dLon/2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
    function isCustomerCategory(cat){
      if(!cat) return false;
      return (
        cat.includes("‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©") ||
        cat.includes("‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å") ||
        cat.includes("‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å") || // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏±‡πâ‡∏ô
        cat.includes("‡∏™‡∏∏‡∏£‡∏≤") ||
        cat.includes("‡πÄ‡∏´‡∏•‡πâ‡∏≤") ||
        cat.includes("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå")
      );
    }

    // ‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•
    function isCompetitorCategory(cat){
      if(!cat) return false;
      return (
        cat.includes("‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•") ||
        cat.includes("‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤") ||
        cat.includes("‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•")
      );
    }

    // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á:
    // - demandScore ‡∏¢‡∏¥‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏¢‡∏≠‡∏∞‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ = ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏•‡∏î
    //   > ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ map ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0..5 ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô = 0..100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡∏µ
    // - competitionScore ‡∏¢‡∏¥‡πà‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡∏¢‡∏¥‡πà‡∏á‡πÅ‡∏¢‡πà = ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
    //   > map ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á 0..5 ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô = 0..100 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏î‡∏±‡∏ô
    //
    // riskRaw = 0.6*(competitionScore) + 0.4*(100 - demandScore)
    // 0   = ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏°‡∏≤‡∏Å
    // 100 = ‡πÅ‡∏Ç‡πà‡∏á‡∏î‡∏∏ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢
    function calcRisk(customersNearby, competitorsNearby){
      const cap = 5; // ‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏°‡∏≠‡∏á‡∏ß‡πà‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß
      const demandScore = Math.min(customersNearby / cap, 1) * 100;
      const competitionScore = Math.min(competitorsNearby / cap, 1) * 100;
      const raw = 0.6*competitionScore + 0.4*(100 - demandScore);
      return raw;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -> ‡∏™‡∏µ/‡πÄ‡∏•‡πÄ‡∏ö‡∏•/‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥
    function classifyRisk(score){
      // rule:
      // <=25   ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
      // <=50   ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
      // <=75   ‡∏™‡πâ‡∏°
      // >75    ‡πÅ‡∏î‡∏á
      if(score <= 25){
        return { label:"‡∏ï‡πà‡∏≥", color:"#22c55e", emoji:"üü¢" };
      } else if(score <= 50){
        return { label:"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", color:"#eab308", emoji:"üü°" };
      } else if(score <= 75){
        return { label:"‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á", color:"#f97316", emoji:"üü†" };
      } else {
        return { label:"‡∏™‡∏π‡∏á", color:"#ef4444", emoji:"üî¥" };
      }
    }

    // -----------------------------
    // 2) main logic
    // -----------------------------

    Promise.all([
      fetch("../data/subdistricts.csv").then(r=>r.text()),
      fetch("../data/factories.csv").then(r=>r.text())
    ])
    .then(([subText, facText]) => {
      const subRows = parseCSV(subText);
      const facRows = parseCSV(facText);

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° factories ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ {lat,lng,category}
      const factories = facRows
        .map(f => {
          const lat = parseFloat(f.lat);
          const lng = parseFloat(f.lng);
          return {
            lat,
            lng,
            cat: f.category || "",
            name: f.name || ""
          };
        })
        .filter(p => !isNaN(p.lat) && !isNaN(p.lng));

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≠ 1 ‡∏ï‡∏≥‡∏ö‡∏•
      const result = subRows.map(s => {
        const slat = parseFloat(s.lat);
        const slng = parseFloat(s.lng);
        const pop = Number(s.population);

        if(isNaN(slat) || isNaN(slng)){
          return null;
        }

        // ‡∏ô‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 3 ‡∏Å‡∏°.
        let customersNearby = 0;
        let competitorsNearby = 0;
        factories.forEach(f => {
          const dist = distanceKm(slat, slng, f.lat, f.lng);
          if(dist <= 3){
            if(isCustomerCategory(f.cat)) customersNearby++;
            if(isCompetitorCategory(f.cat)) competitorsNearby++;
          }
        });

        const riskScore = calcRisk(customersNearby, competitorsNearby);
        const riskInfo = classifyRisk(riskScore);

        return {
          district_th: s.district_th || s["‡∏≠‡∏≥‡πÄ‡∏†‡∏≠"] || "",
          subdistrict_th: s.subdistrict_th || s["‡∏ï‡∏≥‡∏ö‡∏•_TH"] || "",
          population: isNaN(pop) ? null : pop,
          customersNearby,
          competitorsNearby,
          riskScore,
          riskInfo
        };
      }).filter(Boolean);

      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const tbody = document.getElementById("riskTableBody");
      tbody.innerHTML = "";
      result.forEach(r => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${r.district_th || "-"}</td>
          <td>
            <div style="color:#fff;font-weight:600;">
              ${r.subdistrict_th || "-"}
            </div>
          </td>
          <td>${r.population !== null ? r.population.toLocaleString("th-TH") + " ‡∏Ñ‡∏ô" : "-"}</td>
          <td>${r.customersNearby}</td>
          <td>${r.competitorsNearby}</td>
          <td>${r.riskScore.toFixed(1)}</td>
          <td>
            <span class="risk-badge" style="background:${r.riskInfo.color};">
              ${r.riskInfo.emoji} ${r.riskInfo.label}
            </span>
          </td>
        `;

        tbody.appendChild(tr);
      });

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
      if(result.length > 0){
        const avgScore = result.reduce((sum,r)=>sum+r.riskScore,0)/result.length;
        const overall = classifyRisk(avgScore);

        document.getElementById("overallScore").textContent = avgScore.toFixed(1);
        document.getElementById("overallLabel").textContent = `${overall.emoji} ${overall.label}`;

        const dot = document.getElementById("overallColorDot");
        dot.style.background = overall.color;
        dot.title = overall.label + " ("+avgScore.toFixed(1)+")";
      } else {
        document.getElementById("overallScore").textContent = "--";
        document.getElementById("overallLabel").textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      }
    })
    .catch(err => {
      console.error("‡πÇ‡∏´‡∏•‡∏î CSV ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
      document.getElementById("overallScore").textContent = "ERR";
      document.getElementById("overallLabel").textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    });
  </script>
</body>
</html>
