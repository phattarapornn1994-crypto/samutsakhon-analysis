<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà - ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
    }

    header {
      background: #1e293b;
      padding: 12px 16px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header .brand {
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }
    header nav a {
      color: #94a3b8;
      margin-right: 12px;
      text-decoration: none;
      font-size: 13px;
    }
    header nav a:hover {
      color: #fff;
    }
    header nav a.active {
      color: #38bdf8;
      font-weight: 600;
    }

    main {
      padding: 24px 16px 48px;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
    }

    .card {
      background: rgba(15,23,42,.8);
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 20px;
      box-shadow: 0 24px 64px rgb(0 0 0 / .7);
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metric-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      border-bottom: 1px solid #334155;
      padding: 8px 0 12px;
      margin-bottom: 8px;
      font-size: 13px;
      line-height: 1.4;
      color: #cbd5e1;
    }
    .metric-left {
      max-width: 70%;
    }
    .metric-right {
      text-align: right;
      min-width: 90px;
      font-weight: 600;
      color: #fff;
    }

    .score-box {
      font-size: 32px;
      font-weight: 600;
      line-height: 1.2;
      margin-bottom: 8px;
    }
    .score-emoji {
      font-size: 20px;
      margin-left: 8px;
    }
    .score-interpret {
      font-size: 13px;
      color: #cbd5e1;
      line-height: 1.4;
    }

    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }

    .small-note {
      color:#64748b;
      font-size:12px;
      line-height:1.5;
    }

    .flex-row {
      display:flex;
      flex-wrap:wrap;
      gap:16px;
    }

    .half {
      flex:1 1 260px;
      min-width:260px;
    }

    .danger-pill {
      display:inline-block;
      font-size:11px;
      line-height:1.3;
      padding:4px 8px;
      border-radius:999px;
      font-weight:600;
      color:#0f172a;
      background:#eab308;
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ Spatial Intelligence</div>
    <nav>
      <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
      <a href="map.html">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
      <a href="competition.html">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</a>
      <a href="risk.html" class="active">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</a>
    </nav>
  </header>

  <main>
    <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° -->
    <section class="card" id="summary-card">
      <div class="section-title">
        <span>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° (‡∏£‡∏±‡∏®‡∏°‡∏µ <span id="radius-km-label">5</span> ‡∏Å‡∏°.)</span>
      </div>

      <div class="score-box" id="total-risk-score">
        --<span class="score-emoji" id="total-risk-emoji">üü¢</span>
      </div>
      <div class="score-interpret" id="total-risk-interpret">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô...
      </div>

      <div class="small-note" style="margin-top:12px;">
        ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•) + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏≠‡∏ö‡πÑ‡∏ã‡∏ï‡πå ‡πÄ‡∏õ‡πá‡∏ô proxy ‡∏Ç‡∏≠‡∏á
        <span class="danger-pill">‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô + ‡∏°‡∏•‡∏û‡∏¥‡∏© + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</span>
      </div>
    </section>

    <div class="flex-row">
      <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô -->
      <section class="card half">
        <div class="section-title">
          <span>1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</span>
        </div>

        <div class="metric-row">
          <div class="metric-left">
            ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• / ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤) ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ <span id="radius-km-a">5</span> ‡∏Å‡∏°.
          </div>
          <div class="metric-right" id="competitor-count">-</div>
        </div>

        <div class="metric-row">
          <div class="metric-left">
            ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á
            <div class="small-note">
              ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‚Üí ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ñ‡∏π‡∏Å‡πÅ‡∏¢‡πà‡∏á‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡∏™‡∏π‡∏á
            </div>
          </div>
          <div class="metric-right" id="competition-risk-score">- /100</div>
        </div>

        <div class="small-note" id="competition-interpret">
          ...
        </div>
      </section>

      <!-- ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà -->
      <section class="card half">
        <div class="section-title">
          <span>2. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
        </div>

        <div class="metric-row">
          <div class="metric-left">
            ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
            <div class="small-note">
              ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏•‡∏û‡∏¥‡∏© ‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏±‡∏ê
            </div>
          </div>
          <div class="metric-right" id="allfactories-count">-</div>
        </div>

        <div class="metric-row">
          <div class="metric-left">
            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°
          </div>
          <div class="metric-right" id="impact-risk-score">- /100</div>
        </div>

        <div class="small-note" id="impact-interpret">
          ...
        </div>
      </section>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏≠‡∏ö‡πÑ‡∏ã‡∏ï‡πå -->
    <section class="card">
      <div class="section-title">3. ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏≠‡∏ö‡πÑ‡∏ã‡∏ï‡πå (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)</div>
      <div id="competitor-list" style="font-size:13px;line-height:1.5;color:#cbd5e1;">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
      </div>
    </section>

    <section class="card">
      <div class="section-title">‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏µ</div>
      <div class="small-note">
        üü¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ ‚Äì ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ê‡∏≤‡∏ô ‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö<br/>
        üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‚Äì ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå<br/>
        üü† ‡∏™‡∏π‡∏á ‚Äì ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô<br/>
        üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï ‚Äì ‡∏≠‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß/‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏π‡∏á ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏£‡∏á‡∏ï‡πâ‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏ñ‡∏µ‡πà
      </div>
    </section>
  </main>

  <footer>
    ¬© ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ ¬∑ Prototype ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏£‡∏≠‡∏ö‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á
  </footer>

  <script>
    // ---------- parser CSV ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô map.html ----------
    function parseFactoriesCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const factories = [];

      let startIndex = 0;
      const firstLineLower = lines[0].toLowerCase();
      const looksLikeHeader =
        firstLineLower.includes('category') ||
        firstLineLower.includes('name') ||
        firstLineLower.includes('lat');
      if (looksLikeHeader) {
        startIndex = 1;
      }

      for (let i = startIndex; i < lines.length; i++) {
        let row = lines[i].trim();
        if (!row) continue;

        // address ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ "" ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤
        let address = '';
        let addressMatch = row.match(/"([^"]*)"/);
        if (addressMatch) {
          address = addressMatch[1].trim();
          row = row.replace(addressMatch[0], '##ADDRESS_PLACEHOLDER##');
        }

        const parts = row.split(',').map(p => p.trim());
        if (parts.length < 6) continue;

        const category = parts[0] || '';
        const name = parts[1] || '';
        const detail = parts[2] || '';

        let reconstructedAddress = parts[3];
        if (reconstructedAddress === '##ADDRESS_PLACEHOLDER##') {
          reconstructedAddress = address;
        }

        const lat = parseFloat(parts[4]);
        const lng = parseFloat(parts[5]);
        if (isNaN(lat) || isNaN(lng)) continue;

        factories.push({
          category,
          name,
          detail,
          address: reconstructedAddress,
          lat,
          lng
        });
      }

      return factories;
    }

    // ---------- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.) ----------
    function distanceKm(lat1, lng1, lat2, lng2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI/180;
      const dLng = (lng2 - lng1) * Math.PI/180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1*Math.PI/180) *
        Math.cos(lat2*Math.PI/180) *
        Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // ---------- ‡∏à‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö map.html) ----------
    const redBullSite = {
      name: "‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á (‡∏à‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà)",
      address: "‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏¢‡πÉ‡∏¢‡∏£‡∏±‡∏Å ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£",
      lat: 13.565126,
      lng: 100.279895
    };

    // ---------- ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏Å‡∏°.) ----------
    const ANALYSIS_RADIUS_KM = 5;

    // ---------- ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å ----------
    function isRecyclingFactory(f) {
      return f.category.includes("‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•");
    }

    // ---------- ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -> ‡∏™‡∏µ/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ ----------
    function getRiskLevelInfo(score) {
      if (score <= 25) {
        return { color:"üü¢", text:"‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ / ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏•‡∏≤‡∏î‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏ß‡πâ‡∏≤‡∏á" };
      } else if (score <= 50) {
        return { color:"üü°", text:"‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á / ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏î‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏≠‡∏ö‡∏Ç‡πâ‡∏≤‡∏á" };
      } else if (score <= 75) {
        return { color:"üü†", text:"‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á / ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£" };
      } else {
        return { color:"üî¥", text:"‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï / ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏°‡∏≤‡∏Å" };
      }
    }

    // ---------- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ----------
    function analyzeRisk(factories) {
      // ‡∏Ñ‡∏±‡∏î‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ
      const inside = factories.filter(f => {
        const d = distanceKm(redBullSite.lat, redBullSite.lng, f.lat, f.lng);
        return d <= ANALYSIS_RADIUS_KM;
      });

      // ‡∏ô‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)
      const competitors = inside.filter(isRecyclingFactory);

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
      // ‡∏™‡∏°‡∏°‡∏ï‡∏¥: 20 ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á = ‡πÄ‡∏ï‡πá‡∏° 100
      const maxCompetitorRef = 20;
      const competitionScoreRaw = (competitors.length / maxCompetitorRef) * 100;
      const competitionScore = Math.min(100, Math.round(competitionScoreRaw));

      // ‡∏™‡∏°‡∏°‡∏ï‡∏¥: 50 ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏° = ‡πÄ‡∏ï‡πá‡∏° 100
      const maxAllRef = 50;
      const impactScoreRaw = (inside.length / maxAllRef) * 100;
      const impactScore = Math.min(100, Math.round(impactScoreRaw));

      // ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° = ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏≠‡∏á‡∏≠‡∏±‡∏ô
      const totalScore = Math.round((competitionScore + impactScore) / 2);

      // ‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏µ
      return {
        radiusKm: ANALYSIS_RADIUS_KM,
        allFactoriesInRadius: inside,
        competitorsInRadius: competitors,
        competitionScore,
        competitionExplain: getRiskLevelInfo(competitionScore),
        impactScore,
        impactExplain: getRiskLevelInfo(impactScore),
        totalScore,
        totalExplain: getRiskLevelInfo(totalScore)
      };
    }

    // ---------- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ----------
    function renderRisk(result) {
      // ‡∏£‡∏±‡∏®‡∏°‡∏µ
      document.getElementById("radius-km-label").textContent = result.radiusKm;
      document.getElementById("radius-km-a").textContent = result.radiusKm;

      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
      document.getElementById("competitor-count").textContent =
        result.competitorsInRadius.length + " ‡∏£‡∏≤‡∏¢";

      document.getElementById("allfactories-count").textContent =
        result.allFactoriesInRadius.length + " ‡∏£‡∏≤‡∏¢";

      // competition score
      document.getElementById("competition-risk-score").textContent =
        result.competitionScore + " /100";
      document.getElementById("competition-interpret").textContent =
        result.competitionExplain.color + " " + result.competitionExplain.text;

      // impact score
      document.getElementById("impact-risk-score").textContent =
        result.impactScore + " /100";
      document.getElementById("impact-interpret").textContent =
        result.impactExplain.color + " " + result.impactExplain.text;

      // total summary
      document.getElementById("total-risk-score").innerHTML =
        result.totalScore +
        '<span class="score-emoji" id="total-risk-emoji">' +
        result.totalExplain.color +
        "</span>";

      document.getElementById("total-risk-interpret").textContent =
        result.totalExplain.text;

      // competitor list
      const listDiv = document.getElementById("competitor-list");
      if (result.competitorsInRadius.length === 0) {
        listDiv.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î";
      } else {
        let html = "<ol style='margin-top:0;padding-left:20px;'>";
        result.competitorsInRadius.forEach(f => {
          html += `
            <li style="margin-bottom:8px;">
              <div style="color:#fff;font-weight:600;">${f.name || "-"}</div>
              <div style="color:#94a3b8;font-size:12px;line-height:1.4;">
                ${f.address || ""}
                <br/>
                (${f.lat.toFixed(5)}, ${f.lng.toFixed(5)})
              </div>
            </li>
          `;
        });
        html += "</ol>";
        listDiv.innerHTML = html;
      }
    }

    // ---------- main: ‡πÇ‡∏´‡∏•‡∏î CSV ----------
    fetch("data/factories.csv", { cache: "no-store" })
      .then(res => res.text())
      .then(csvText => {
        const factories = parseFactoriesCSV(csvText);
        const result = analyzeRisk(factories);
        renderRisk(result);
      })
      .catch(err => {
        console.error("‡πÇ‡∏´‡∏•‡∏î factories.csv ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
        document.getElementById("total-risk-interpret").textContent =
          "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      });
  </script>

</body>
</html>
  </script>

</body>
</html>
