<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà - ‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse (‡∏≠‡πà‡∏≤‡∏ô CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg-main:#0f172a;
      --bg-card:#1e293b;
      --bg-card-glass:rgba(15,23,42,0.8);
      --line:#334155;
      --text-dim:#94a3b8;
      --text:#f8fafc;
      --text-strong:#fff;
      --radius-lg:16px;
      --radius-md:12px;
    }

    body {
      font-family: system-ui, sans-serif;
      background: var(--bg-main);
      color: var(--text);
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
    }

    header {
      background: #1e293b;
      padding: 12px 16px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color:#fff;
    }
    header .brand {
      font-weight:600;
      font-size:14px;
      color:#fff;
    }
    header nav a {
      color: #94a3b8;
      margin-right: 12px;
      text-decoration: none;
      font-size: 13px;
    }
    header nav a:hover {
      color: #fff;
    }

    main {
      display: grid;
      grid-template-columns: 320px 1fr;
      min-height: 0;
    }

    /* panel ‡∏ã‡πâ‡∏≤‡∏¢ */
    .side-panel {
      background: #0f172a;
      border-right:1px solid #334155;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:16px;
      min-height:0;
      overflow-y:auto;
    }

    .card {
      background: var(--bg-card-glass);
      backdrop-filter: blur(8px);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 60px rgb(0 0 0 / .7);
      padding:16px 20px;
      color:#cbd5e1;
      font-size:13px;
      line-height:1.5;
    }
    .card h2,
    .card h3 {
      margin:0 0 8px;
      color:#fff;
      font-size:14px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
      line-height:1.4;
    }

    .control-group {
      margin-bottom:12px;
      font-size:13px;
    }
    .control-group label {
      color:#fff;
      font-size:13px;
      font-weight:500;
      display:block;
      margin-bottom:6px;
    }
    .control-row-inline {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .radius-value {
      font-size:12px;
      color:#94a3b8;
    }
    input[type="range"] {
      width:100%;
    }
    .checkbox-list {
      max-height:120px;
      overflow-y:auto;
      background:#1e2537;
      border:1px solid #334155;
      border-radius: var(--radius-md);
      padding:8px 12px;
      font-size:12px;
      line-height:1.4;
    }
    .checkbox-row {
      display:flex;
      align-items:flex-start;
      gap:6px;
      margin-bottom:6px;
      color:#cbd5e1;
    }
    .checkbox-row input {
      margin-top:2px;
    }

    .metrics-grid {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    .metric-box {
      background:#1e2537;
      border:1px solid #334155;
      border-radius: var(--radius-md);
      padding:10px 12px;
      font-size:12px;
      line-height:1.4;
      box-shadow:0 12px 32px rgb(0 0 0 / .6);
    }
    .metric-label {
      color:#94a3b8;
      font-size:11px;
      margin-bottom:2px;
    }
    .metric-value {
      font-size:16px;
      font-weight:600;
      color:#fff;
      line-height:1.3;
    }
    .metric-sub {
      font-size:11px;
      color:#94a3b8;
    }

    .risk-summary-main {
      background:#1e2537;
      border:1px solid #334155;
      border-radius: var(--radius-md);
      padding:12px 16px;
      margin-top:12px;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
    }
    .risk-score-row {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
    }
    .risk-total {
      font-size:28px;
      font-weight:600;
      line-height:1.1;
      color:#fff;
    }
    .risk-badge {
      font-size:13px;
      font-weight:600;
      line-height:1.2;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #334155;
      box-shadow:0 12px 32px rgb(0 0 0 / .6);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .risk-explain {
      font-size:12px;
      color:#cbd5e1;
      margin-top:8px;
      line-height:1.5;
    }

    /* map */
    #map-wrapper {
      position:relative;
      background:#000;
    }
    #map {
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      min-height:400px;
    }

    .leaflet-popup-content-wrapper {
      background:#1e293b;
      color:#f8fafc;
      border-radius:12px;
      border:1px solid #475569;
      box-shadow:0 20px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:#1e293b;
      border:1px solid #475569;
    }
    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:#cbd5e1;
      line-height:1.4;
    }

    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }

    /* ‡∏™‡∏µ badge ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á */
    .badge-low     { background:#064e3b; color:#d1fae5; }
    .badge-medium  { background:#78350f; color:#ffedd5; }
    .badge-high    { background:#7f1d1d; color:#fee2e2; }
    .badge-veryhigh{ background:#450a0a; color:#fee2e2; border-color:#dc2626 !important; }

    @media(max-width:900px){
      main {
        grid-template-columns:1fr;
      }
      #map-wrapper {
        order:-1;
        height:50vh;
        min-height:320px;
      }
      .side-panel {
        max-height:none;
        border-right:0;
        border-top:1px solid #334155;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="brand">üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Beta)</div>
  <nav>
    <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    <a href="map.html">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°</a>
    <a href="competition.html">‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á & ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
    <a href="risk.html" style="color:#fff;font-weight:600;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</a>
  </nav>
</header>

<main>
  <!-- SIDE PANEL -->
  <aside class="side-panel">

    <!-- CONTROL -->
    <section class="card">
      <h2>‚öô ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>

      <!-- ‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏±‡∏®‡∏°‡∏µ -->
      <div class="control-group">
        <div class="control-row-inline">
          <label for="radiusKm">‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏Å‡∏°.)</label>
          <div class="radius-value"><span id="radiusLabel">5</span> ‡∏Å‡∏°.</div>
        </div>
        <input id="radiusKm" type="range" min="1" max="10" step="1" value="5" />
        <div style="font-size:11px;color:#94a3b8;line-height:1.4;">
          ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏≠‡∏ö‡∏à‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á
        </div>
      </div>

      <!-- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£ -->
      <div class="control-group">
        <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á (‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢)</label>
        <div class="checkbox-list" id="customerCategoryList">
          <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å CSV -->
          <!-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 
          <div class="checkbox-row">
            <input type="checkbox" data-cat="‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©" checked />
            <span>‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</span>
          </div>
          -->
        </div>
        <div style="font-size:11px;color:#94a3b8;line-height:1.4;margin-top:4px;">
          ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å / ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏£‡∏≤
          (‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á)
        </div>
      </div>
    </section>

    <!-- SUMMARY RISK -->
    <section class="card">
      <h2>üî• ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h2>

      <div class="risk-summary-main">
        <div class="risk-score-row">
          <div class="risk-total" id="totalRiskScore">--</div>
          <div class="risk-badge badge-low" id="totalRiskBadge">
            <span id="totalRiskEmoji">üü¢</span>
            <span id="totalRiskLabel">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
          </div>
        </div>

        <div class="risk-explain" id="totalRiskExplain">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà / ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢)
        </div>
      </div>

      <div class="metrics-grid" style="margin-top:16px;">
        <div class="metric-box">
          <div class="metric-label">‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ</div>
          <div class="metric-value" id="competitorCountBox">--</div>
          <div class="metric-sub">
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô:
            <span id="competitionRiskBox">--</span>/100
          </div>
        </div>

        <div class="metric-box">
          <div class="metric-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å)</div>
          <div class="metric-value" id="customerCountBox">--</div>
          <div class="metric-sub">
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢:
            <span id="supplyRiskBox">--</span>/100
          </div>
        </div>

        <div class="metric-box">
          <div class="metric-label">‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
          <div class="metric-value"><span id="nearestCompetitorKmBox">--</span> ‡∏Å‡∏°.</div>
          <div class="metric-sub">
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏£‡∏∞‡∏ä‡∏¥‡∏î:
            <span id="proximityRiskBox">--</span>/100
          </div>
        </div>

        <div class="metric-box">
          <div class="metric-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
          <div class="metric-value" style="font-size:13px;line-height:1.4;" id="situationSummaryBox">
            --
          </div>
        </div>
      </div>
    </section>

    <!-- HOW TO READ -->
    <section class="card">
      <h3>üü¢üü°üü†üî¥ ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏ú‡∏•</h3>
      <div style="font-size:12px;line-height:1.5;color:#cbd5e1;">
        <p><b>0-29 (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)</b> = ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÇ‡∏•‡πà‡∏á</p>
        <p><b>30-59 (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</b> = ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏ô ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á</p>
        <p><b>60-79 (‡∏™‡πâ‡∏°)</b> = ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏î‡∏∏ / ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</p>
        <p><b>80-100 (‡πÅ‡∏î‡∏á)</b> = ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á ‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏±‡∏î‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠</p>
      </div>
    </section>

  </aside>

  <!-- MAP -->
  <section id="map-wrapper">
    <div id="map"></div>
  </section>
</main>

<footer>
  ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏¥‡∏á‡∏†‡∏π‡∏°‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ó‡∏î‡∏•‡∏≠‡∏á | ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡∏≤‡∏ô / CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô
</footer>

<script>
/* --------------------------------------------------
   CONFIG ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
   -------------------------------------------------- */

// ‡∏û‡∏¥‡∏Å‡∏±‡∏î "‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á" ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
// ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
const SITE_LAT = 13.59;
const SITE_LNG = 100.28;

// path CSV ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
const CSV_URL = "data/factories.csv";

// ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô‡∏™‡πÄ‡∏Å‡∏•‡∏Å‡∏≤‡∏£ normalize
const MAX_COMPETITORS_SCALE = 30; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á >=30 ‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ -> ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á max
const BASE_CUSTOMER_GOOD    = 50; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ >=50 ‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ -> ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÇ‡∏≠‡πÄ‡∏Ñ -> ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥

// ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
const W_COMPETITION = 0.5;
const W_PROXIMITY   = 0.3;
const W_SUPPLY      = 0.2;

// ‡∏´‡∏°‡∏ß‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ default ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
// (‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÇ‡∏ü‡∏Å‡∏±‡∏™: ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å / ‡∏™‡∏∏‡∏£‡∏≤)
const DEFAULT_CUSTOMER_HINTS = [
  "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©",
  "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å",
  "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏£‡∏≤"
];

// ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á" (‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)
function isCompetitorCategory(cat) {
  // ‡∏ï‡∏£‡∏á ‡πÜ ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•"
  // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏ß‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
  return cat && cat.includes("‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•");
}

/* --------------------------------------------------
   ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà Leaflet
   -------------------------------------------------- */

const map = L.map("map", {
  zoomControl: true,
  attributionControl: true,
});

// base tile (‡πÉ‡∏ä‡πâ OSM)
const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap contributors',
  }
).addTo(map);

// ‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏•‡∏≤‡∏ô
map.setView([SITE_LAT, SITE_LNG], 12);

// marker ‡∏à‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á
const siteMarker = L.circleMarker([SITE_LAT, SITE_LNG], {
  radius:8,
  color:"#38bdf8",
  weight:2,
  fillColor:"#0ea5e9",
  fillOpacity:0.9
})
.bindPopup(`
  <div class="popup-title">‡∏à‡∏∏‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏•‡∏±‡∏Å</div>
  <div class="popup-desc">‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á / ‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</div>
`)
.addTo(map);

// ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
let radiusCircle = null;

// ‡∏Å‡∏•‡∏∏‡πà‡∏° marker ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡πÅ‡∏î‡∏á) ‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ü‡πâ‡∏≤)
const competitorLayer = L.layerGroup().addTo(map);
const customerLayer   = L.layerGroup().addTo(map);

// ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î CSV
let factoryData = [];

// ‡πÄ‡∏Å‡πá‡∏ö checkbox DOM map ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î
const categoryCheckboxes = {}; // { "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©": inputElement, ... }

/* --------------------------------------------------
   Utils: ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (km) ‡∏î‡πâ‡∏ß‡∏¢ haversine
   -------------------------------------------------- */
function haversineKm(lat1, lon1, lat2, lon2) {
  const R = 6371; // ‡πÇ‡∏•‡∏Å ~6371 km
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* --------------------------------------------------
   ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏¢‡πà‡∏≠‡∏¢
   -------------------------------------------------- */
function calcCompetitionRiskScore(competitorCount) {
  // ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞ -> ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á
  const raw = competitorCount / MAX_COMPETITORS_SCALE;
  const clamped = Math.min(raw, 1);
  return clamped * 100;
}

function calcSupplyRiskScore(customerCount) {
  // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏¢‡∏≠‡∏∞ -> ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡∏î‡∏µ -> ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥
  // ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á"
  const opportunity = Math.min(customerCount / BASE_CUSTOMER_GOOD, 1);
  return (1 - opportunity) * 100;
}

function calcProximityRiskScore(nearestKm) {
  // ‡πÉ‡∏Å‡∏•‡πâ‡∏°‡∏≤‡∏Å (<1km) = ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á 100
  // ‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡∏Å (>=5km) = ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á 0
  if (!isFinite(nearestKm)) {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏•‡∏¢
    return 0;
  }
  if (nearestKm <= 1) return 100;
  if (nearestKm >= 5) return 0;
  const t = (nearestKm - 1) / (5 - 1); // 0 ‡∏ó‡∏µ‡πà1km ->1 ‡∏ó‡∏µ‡πà5km
  return (1 - t) * 100;
}

function calcTotalRiskIndex(rComp, rProx, rSupp) {
  return (rComp * W_COMPETITION) +
         (rProx * W_PROXIMITY) +
         (rSupp * W_SUPPLY);
}

/* --------------------------------------------------
   ‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° -> ‡∏™‡∏µ/‡∏õ‡πâ‡∏≤‡∏¢
   -------------------------------------------------- */
function interpretRisk(score) {
  // return {label,emoji,badgeClass}
  if (score < 30) {
    return {
      label: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥",
      emoji: "üü¢",
      badgeClass: "badge-low",
      explain: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏û‡∏≠"
    };
  } else if (score < 60) {
    return {
      label: "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á",
      emoji: "üü°",
      badgeClass: "badge-medium",
      explain: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏î‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏ö‡∏ï‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô"
    };
  } else if (score < 80) {
    return {
      label: "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á",
      emoji: "üü†",
      badgeClass: "badge-high",
      explain: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏î‡∏∏ / ‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£"
    };
  } else {
    return {
      label: "‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å",
      emoji: "üî¥",
      badgeClass: "badge-veryhigh",
      explain: "‡∏ï‡∏•‡∏≤‡∏î‡∏≠‡∏±‡∏î‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡πÅ‡∏£‡∏á‡∏ö‡∏µ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡∏™‡∏π‡∏á ‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°‡∏≠‡∏≤‡∏à‡∏ö‡∏≤‡∏á"
    };
  }
}

/* --------------------------------------------------
   ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î / ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
   -------------------------------------------------- */
function updateAnalysis() {
  const radiusKm = parseFloat(document.getElementById("radiusKm").value);
  document.getElementById("radiusLabel").textContent = radiusKm.toString();

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ß‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  const radiusMeters = radiusKm * 1000;
  if (radiusCircle) {
    map.removeLayer(radiusCircle);
  }
  radiusCircle = L.circle([SITE_LAT, SITE_LNG], {
    radius: radiusMeters,
    color:"#facc15",
    weight:2,
    fillColor:"#fde047",
    fillOpacity:0.08
  }).addTo(map);

  // ‡∏´‡∏°‡∏ß‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡πä‡∏Å
  const activeCustomerCats = Object.keys(categoryCheckboxes)
    .filter(cat => categoryCheckboxes[cat].checked);

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå layer marker ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
  competitorLayer.clearLayers();
  customerLayer.clearLayers();

  let competitorsInRange = [];
  let customersInRange   = [];

  // loop ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  for (const item of factoryData) {
    const dKm = haversineKm(SITE_LAT, SITE_LNG, item.lat, item.lng);
    if (dKm <= radiusKm) {
      if (isCompetitorCategory(item.category)) {
        competitorsInRange.push({ ...item, distKm:dKm });
      }
      // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ = ‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å
      if (activeCustomerCats.includes(item.category)) {
        customersInRange.push({ ...item, distKm:dKm });
      }
    }
  }

  // ‡∏´‡∏≤ nearest competitor
  let nearestDist = Infinity;
  competitorsInRange.forEach(c => {
    if (c.distKm < nearestDist) nearestDist = c.distKm;
  });

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì risk ‡∏¢‡πà‡∏≠‡∏¢
  const competitorCount = competitorsInRange.length;
  const customerCount   = customersInRange.length;

  const rComp = calcCompetitionRiskScore(competitorCount);
  const rSupp = calcSupplyRiskScore(customerCount);
  const rProx = calcProximityRiskScore(nearestDist);

  const totalRisk = calcTotalRiskIndex(rComp, rProx, rSupp);

  // ‡πÅ‡∏õ‡∏•‡∏ú‡∏•‡∏£‡∏ß‡∏°
  const interp = interpretRisk(totalRisk);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI summary
  document.getElementById("competitorCountBox").textContent = competitorCount;
  document.getElementById("customerCountBox").textContent   = customerCount;
  document.getElementById("nearestCompetitorKmBox").textContent =
    isFinite(nearestDist) ? nearestDist.toFixed(2) : "-";

  document.getElementById("competitionRiskBox").textContent = rComp.toFixed(0);
  document.getElementById("supplyRiskBox").textContent      = rSupp.toFixed(0);
  document.getElementById("proximityRiskBox").textContent   = rProx.toFixed(0);

  document.getElementById("totalRiskScore").textContent     = totalRisk.toFixed(0) + "/100";
  document.getElementById("totalRiskEmoji").textContent     = interp.emoji;
  document.getElementById("totalRiskLabel").textContent     = interp.label;
  document.getElementById("totalRiskExplain").textContent   = interp.explain;

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏•‡∏≤‡∏™‡∏Ç‡∏≠‡∏á badge ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö
  const badge = document.getElementById("totalRiskBadge");
  badge.className = "risk-badge " + interp.badgeClass;

  // situation summary ‡∏™‡∏±‡πâ‡∏ô‡πÜ
  let summaryTxt = "";
  summaryTxt += `‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• ${competitorCount} ‡πÅ‡∏´‡πà‡∏á`;
  if (isFinite(nearestDist)) {
    summaryTxt += ` (‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î ~${nearestDist.toFixed(2)} ‡∏Å‡∏°.)`;
  }
  summaryTxt += ` | ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${customerCount} ‡πÅ‡∏´‡πà‡∏á`;
  summaryTxt += ` | ‡∏£‡∏±‡∏®‡∏°‡∏µ ${radiusKm} ‡∏Å‡∏°.`;
  document.getElementById("situationSummaryBox").textContent = summaryTxt;

  // ‡∏ß‡∏≤‡∏î marker ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°)
  competitorsInRange.forEach(c => {
    const m = L.circleMarker([c.lat, c.lng], {
      radius:6,
      color:"#dc2626",
      weight:2,
      fillColor:"#ef4444",
      fillOpacity:0.8
    }).bindPopup(`
      <div class="popup-title">${c.name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)"}</div>
      <div class="popup-desc">
        <div><b>‡∏´‡∏°‡∏ß‡∏î:</b> ${c.category}</div>
        <div><b>‡∏£‡∏∞‡∏¢‡∏∞:</b> ${c.distKm.toFixed(2)} ‡∏Å‡∏°.</div>
        <div style="margin-top:4px;">${c.address || ""}</div>
      </div>
    `);
    competitorLayer.addLayer(m);
  });

  // ‡∏ß‡∏≤‡∏î marker ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ü‡πâ‡∏≤)
  customersInRange.forEach(c => {
    const m = L.circleMarker([c.lat, c.lng], {
      radius:6,
      color:"#0ea5e9",
      weight:2,
      fillColor:"#38bdf8",
      fillOpacity:0.8
    }).bindPopup(`
      <div class="popup-title">${c.name || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)"}</div>
      <div class="popup-desc">
        <div><b>‡∏´‡∏°‡∏ß‡∏î:</b> ${c.category}</div>
        <div><b>‡∏£‡∏∞‡∏¢‡∏∞:</b> ${c.distKm.toFixed(2)} ‡∏Å‡∏°.</div>
        <div style="margin-top:4px;">${c.address || ""}</div>
      </div>
    `);
    customerLayer.addLayer(m);
  });

}

/* --------------------------------------------------
   ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° checkbox ‡∏´‡∏°‡∏ß‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å
   -------------------------------------------------- */
function buildCustomerCategoryList(uniqueCats) {
  const listEl = document.getElementById("customerCategoryList");
  listEl.innerHTML = "";

  uniqueCats.forEach(cat => {
    if (!cat) return;
    const row = document.createElement("div");
    row.className = "checkbox-row";

    const input = document.createElement("input");
    input.type = "checkbox";
    input.setAttribute("data-cat", cat);

    // default checked? ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î match hints ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
    input.checked = DEFAULT_CUSTOMER_HINTS.some(h => cat.includes(h));

    const labelSpan = document.createElement("span");
    labelSpan.textContent = cat;

    row.appendChild(input);
    row.appendChild(labelSpan);
    listEl.appendChild(row);

    categoryCheckboxes[cat] = input;

    // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏¥‡πä‡∏Å/‡πÄ‡∏≠‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å -> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà
    input.addEventListener("change", () => {
      updateAnalysis();
    });
  });
}

/* --------------------------------------------------
   ‡πÇ‡∏´‡∏•‡∏î CSV ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö
   -------------------------------------------------- */
fetch(CSV_URL)
  .then(res => res.text())
  .then(csvText => {
    const parsed = Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
    });

    // map ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô object ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ
    factoryData = parsed.data
      .map(row => {
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô float
        const lat = parseFloat(row.lat);
        const lng = parseFloat(row.lng);
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÇ‡∏≠‡πÄ‡∏Ñ
        if (isNaN(lat) || isNaN(lng)) return null;
        return {
          category: row.category ? row.category.trim() : "",
          name:     row.name ? row.name.trim() : "",
          type:     row.type ? row.type.trim() : "",
          address:  row.address ? row.address.trim() : "",
          lat,
          lng
        };
      })
      .filter(x => x !== null);

    // unique categories ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const uniqueCatsSet = new Set();
    factoryData.forEach(item => {
      if (item.category && item.category !== "") {
        uniqueCatsSet.add(item.category);
      }
    });
    const uniqueCats = Array.from(uniqueCatsSet).sort();

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á checkbox ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    buildCustomerCategoryList(uniqueCats);

    // bind event ‡∏Ç‡∏≠‡∏á radius
    document.getElementById("radiusKm").addEventListener("input", () => {
      updateAnalysis();
    });

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    updateAnalysis();
  })
  .catch(err => {
    console.error("‡πÇ‡∏´‡∏•‡∏î CSV ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
    document.getElementById("totalRiskExplain").textContent =
      "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (CSV) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå data/factories.csv";
  });
</script>

</body>
</html>
