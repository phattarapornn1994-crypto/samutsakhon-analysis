<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•) - ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      height: 100vh;
    }

    header {
      background: #1e293b;
      padding: 12px 16px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header .title {
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      line-height: 1.4;
    }

    header nav a {
      color: #94a3b8;
      margin-right: 12px;
      text-decoration: none;
      font-size: 13px;
    }
    header nav a:hover {
      color: #fff;
    }

    /* ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ */
    #controls {
      background:#1e293b;
      border-bottom:1px solid #334155;
      padding:12px 16px;
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      font-size:13px;
      line-height:1.4;
      color:#cbd5e1;
    }

    .radius-box {
      background:rgba(15,23,42,.7);
      border:1px solid #334155;
      border-radius:12px;
      padding:12px 16px;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
      max-width:300px;
    }

    .radius-box h2 {
      margin:0 0 8px;
      font-size:14px;
      font-weight:600;
      color:#fff;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .radius-row {
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .radius-row input[type="range"] {
      width:160px;
    }

    .radius-hint {
      font-size:12px;
      color:#94a3b8;
      line-height:1.4;
      margin-top:8px;
    }

    .summary-box {
      background:rgba(15,23,42,.7);
      border:1px solid #334155;
      border-radius:12px;
      padding:12px 16px;
      box-shadow:0 20px 60px rgb(0 0 0 / .7);
      font-size:12px;
      line-height:1.5;
      color:#cbd5e1;
      max-width:360px;
    }
    .summary-box h3 {
      margin:0 0 8px;
      color:#fff;
      font-size:13px;
      font-weight:600;
    }

    /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
    #map-wrapper {
      position: relative;
      background: #000;
      min-height:0;
    }

    #map {
      width: 100%;
      height: 100%;
      min-height: 300px;
      position: absolute;
      inset: 0;
    }

    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }

    /* popup style */
    .leaflet-popup-content-wrapper {
      background:#1e293b;
      color:#f8fafc;
      border-radius:12px;
      border:1px solid #475569;
      box-shadow:0 20px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:#1e293b;
      border:1px solid #475569;
    }
    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:#cbd5e1;
      line-height:1.4;
    }

    /* layer control dark mode */
    .leaflet-control-layers {
      background:#1e293b !important;
      border:1px solid #334155 !important;
      border-radius:12px !important;
      color:#fff !important;
      box-shadow:0 20px 60px rgb(0 0 0 / .8) !important;
      font-size:12px;
      line-height:1.4;
    }
    .leaflet-control-layers-expanded {
      background:#1e293b !important;
      color:#fff !important;
    }
    .leaflet-control-layers-list label {
      color:#cbd5e1;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
  </style>
</head>

<body>
<header>
  <div class="title">üî¥ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏£‡∏≠‡∏ö‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á (‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)</div>
  <nav>
    <a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    <a href="map.html">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
    <a href="population.html">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</a>
    <a href="competition.html" style="color:#fff;">‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</a>
    <a href="risk.html">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</a>
  </nav>
</header>

<section id="controls">
  <div class="radius-box">
    <h2>‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á</h2>
    <div class="radius-row">
      <input id="radiusInput" type="range" min="1000" max="10000" step="500" value="3000" />
      <div style="font-size:13px;color:#fff;">
        <span id="radiusLabel">3.0 ‡∏Å‡∏°.</span>
      </div>
    </div>
    <div class="radius-hint">
      ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏Å‡∏°.) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ô‡∏±‡πâ‡∏ô
    </div>
  </div>

  <div class="summary-box">
    <h3>‡∏ô‡∏¥‡∏¢‡∏≤‡∏°</h3>
    <div>‚Ä¢ "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á" = ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• / ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ / ‡πÄ‡∏°‡πá‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•</div>
    <div>‚Ä¢ ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÅ‡∏î‡∏á = ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</div>
    <div>‚Ä¢ ‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á = ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô</div>
    <div style="margin-top:8px;border-top:1px solid #334155;padding-top:8px;">
      <b>‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏≤:</b> ‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á ‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏¢‡πÉ‡∏¢‡∏£‡∏±‡∏Å<br/>
      (13.565126, 100.279895)
    </div>
  </div>
</section>

<div id="map-wrapper">
  <div id="map"></div>
</div>

<footer>
  ¬© ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏£‡∏≠‡∏ö‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á ¬∑ ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£
</footer>

<script>
  // -------------------------------
  // 1) config ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å
  // -------------------------------

  // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ê‡∏≤‡∏ô‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á
  const redBullLatLng = [13.565126, 100.279895];

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  const map = L.map('map', {
    center: redBullLatLng,
    zoom: 12,
    zoomControl: true,
    attributionControl: false
  });

  // base layers
  const streetLayer = L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 20 }
  ).addTo(map);

  const satelliteLayer = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxZoom: 20 }
  );

  const darkLayer = L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    { maxZoom: 20, subdomains: 'abcd' }
  );

  // layer groups
  const baseLayerGroup = L.layerGroup().addTo(map);      // ‡∏à‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á
  const recycleLayer = L.layerGroup().addTo(map);        // ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ
  let radiusCircle = null;                               // ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ

  // ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á‡πÄ‡∏≠‡∏á
  const redBullMarker = L.circleMarker(redBullLatLng, {
    radius: 8,
    color: '#22c55e',
    fillColor: '#22c55e',
    fillOpacity: 0.9,
    weight: 2
  })
  .bindPopup(`
    <div class="popup-title">‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á (‡∏ê‡∏≤‡∏ô‡πÄ‡∏£‡∏≤)</div>
    <div class="popup-desc">
      ‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏¢‡πÉ‡∏¢‡∏£‡∏±‡∏Å<br/>
      ${redBullLatLng[0].toFixed(5)}, ${redBullLatLng[1].toFixed(5)}
    </div>
  `)
  .addTo(baseLayerGroup);

  // -------------------------------
  // 2) CSV parser (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô map.html)
  // -------------------------------

  function parseCSV(text) {
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",").map(h => h.trim());
    const rows = lines.slice(1);

    return rows.map(row => {
      const cols = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < row.length; i++) {
        const char = row[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          cols.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      cols.push(current.trim());

      const obj = {};
      headers.forEach((h, i) => {
        obj[h] = cols[i] ?? "";
      });
      return obj;
    });
  }

  // -------------------------------
  // 3) ‡∏î‡∏∂‡∏á CSV ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡πâ (allFactories)
  // -------------------------------

  let allFactories = [];

  fetch('data/factories.csv')
    .then(res => res.text())
    .then(text => {
      allFactories = parseCSV(text);
      // ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ render ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      syncRadiusUI(); // ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateView ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    });

  // -------------------------------
  // 4) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2 ‡∏à‡∏∏‡∏î (‡πÄ‡∏°‡∏ï‡∏£)
  // -------------------------------

  function distanceInMeters(lat1,lng1,lat2,lng2){
    const R = 6371000; // ‡πÄ‡∏°‡∏ï‡∏£
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2-lat1);
    const dLng = toRad(lng2-lng1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
              Math.sin(dLng/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // -------------------------------
  // 5) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ
  // -------------------------------

  function updateView(radiusMeters){
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°
    recycleLayer.clearLayers();

    // ‡∏•‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÄ‡∏Å‡πà‡∏≤
    if(radiusCircle){
      map.removeLayer(radiusCircle);
    }

    // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á
    radiusCircle = L.circle(redBullLatLng, {
      radius: radiusMeters,
      color: '#ff0000',
      weight: 2,
      fillColor: '#ff0000',
      fillOpacity: 0.08
    }).addTo(map);

    // ‡πÉ‡∏™‡πà‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á" = category ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•"
    allFactories.forEach(f => {
      if (!f.category) return;
      const isCompetitor = f.category.includes("‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•");
      if(!isCompetitor) return;

      const lat = parseFloat(f.lat);
      const lng = parseFloat(f.lng);
      if (isNaN(lat) || isNaN(lng)) return;

      const dist = distanceInMeters(
        redBullLatLng[0], redBullLatLng[1],
        lat, lng
      );

      if(dist <= radiusMeters){
        const marker = L.circleMarker([lat,lng],{
          radius:6,
          color:'#ef4444',
          fillColor:'#ef4444',
          fillOpacity:0.9,
          weight:1
        }).addTo(recycleLayer);

        marker.bindPopup(`
          <div class="popup-title">${f.name || "(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)"}</div>
          <div class="popup-desc">
            <div><b>‡∏´‡∏°‡∏ß‡∏î:</b> ${f.category || "-"}</div>
            <div><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${f.detail || "-"}</div>
            <div><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${f.address || "-"}</div>
            <div><b>‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á:</b> ${(dist/1000).toFixed(2)} ‡∏Å‡∏°.</div>
            <div><b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
          </div>
        `);
      }
    });
  }

  // -------------------------------
  // 6) ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö slider UI
  // -------------------------------

  const radiusInput = document.getElementById('radiusInput');
  const radiusLabel = document.getElementById('radiusLabel');

  function syncRadiusUI(){
    const r = parseInt(radiusInput.value,10);
    radiusLabel.textContent = (r/1000).toFixed(1) + " ‡∏Å‡∏°.";
    updateView(r);
  }

  radiusInput.addEventListener('input', syncRadiusUI);

  // -------------------------------
  // 7) Layer control
  // -------------------------------

  const baseMaps = {
    "‡∏ñ‡∏ô‡∏ô (OSM)": streetLayer,
    "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°": satelliteLayer,
    "‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î": darkLayer
  };
  const overlayMaps = {
    "‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á": baseLayerGroup,
    "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ": recycleLayer
  };
  L.control.layers(baseMaps, overlayMaps, { collapsed:false }).addTo(map);

</script>
</body>
</html>
