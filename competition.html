<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á & ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏Å‡∏•‡πâ Hub</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg-page: #ffffff;
      --bg-card: #ffffff;
      --border-card: #e2e8f0;
      --text-main: #0f172a;
      --text-dim: #64748b;
      --accent: #0ea5e9;
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-card: 0 24px 40px rgb(0 0 0 / 0.06);

      --recycle-color: #ef4444;   /* ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•) = ‡πÅ‡∏î‡∏á */
      --customer-color: #3b82f6;  /* ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô = ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
      --hub-color: #f97316;       /* Hub ‡πÄ‡∏£‡∏≤ = ‡∏™‡πâ‡∏° */
    }

    body {
      margin: 0;
      background: var(--bg-page);
      color: var(--text-main);
      font-family:
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        Roboto,
        "Helvetica Neue",
        sans-serif;
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
    }

    /* ---------- TOP NAV (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà) ---------- */
    header.site-header {
      background: #ffffff;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      padding: 12px 16px;
      row-gap: 12px;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      min-width: 200px;
    }

    .brand-title {
      font-size: 15px;
      font-weight: 600;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-sub {
      font-size: 12px;
      color: #64748b;
      line-height: 1.3;
    }

    nav.main-nav {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      column-gap: 12px;
      row-gap: 8px;
      font-size: 13px;
      font-weight: 500;
    }

    nav.main-nav a {
      text-decoration: none;
      color: #1e293b;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 6px 10px;
      line-height: 1.2;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    nav.main-nav a span.emoji {
      font-size: 16px;
      line-height: 1;
    }

    nav.main-nav a.active {
      background: #0ea5e9;
      border-color: #0ea5e9;
      color: #fff;
      box-shadow: 0 12px 24px rgb(14 165 233 / 0.35);
    }

    /* ---------- PAGE LAYOUT ---------- */
    main.page-body {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 320px;
      height: calc(100vh - 64px);
      max-height: calc(100vh - 64px);
      border-top: 1px solid var(--border-card);
    }

    /* MAP AREA */
    .map-wrap {
      position: relative;
      background: #fff;
    }

    #map {
      position: absolute;
      inset: 0;
    }

    /* SIDE PANEL */
    aside.side-panel {
      background: var(--bg-card);
      border-left: 1px solid var(--border-card);
      padding: 16px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-main);
    }

    .panel-card {
      background: #ffffff;
      border: 1px solid var(--border-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-card);
      padding: 16px;
      margin-bottom: 16px;
    }

    .panel-headline {
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .panel-desc {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.4;
      margin-bottom: 12px;
    }

    /* RADIUS CONTROL */
    .radius-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      margin-bottom: 12px;
    }
    .radius-row input[type="number"] {
      width: 60px;
      padding: 4px 6px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #fff;
      color: #0f172a;
    }

    /* CATEGORY FILTER */
    .category-list {
      max-height: 140px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px;
      background: #f8fafc;
      font-size: 12px;
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .category-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 6px;
      color: #1e293b;
      cursor: pointer;
    }
    .category-item input[type="checkbox"] {
      margin-top: 2px;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 12px;
    }

    .btn-small {
      appearance: none;
      border: 1px solid #cbd5e1;
      background: #fff;
      font-size: 12px;
      line-height: 1.2;
      border-radius: 6px;
      padding: 5px 8px;
      cursor: pointer;
      color: #0f172a;
    }
    .btn-small:hover {
      background: #e2e8f0;
    }

    /* SUMMARY BOXES */
    .mini-stats {
      display: grid;
      grid-template-columns: repeat(2,1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .stat-box {
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      padding: 10px;
      box-shadow: 0 16px 24px rgb(0 0 0 / .04);
    }
    .stat-label {
      font-size: 11px;
      color: #64748b;
      line-height: 1.3;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 600;
      line-height: 1.3;
      margin-top: 4px;
    }
    .stat-competitor {
      color: var(--recycle-color);
    }
    .stat-customer {
      color: var(--customer-color);
    }

    .list-sites {
      font-size: 12px;
      line-height: 1.4;
      color: #1e293b;
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px;
      background: #fff;
    }
    .site-entry {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }
    .site-entry:last-child {
      border-bottom: 0;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .site-name-line {
      font-weight: 600;
      color: #0f172a;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    .site-name-line .badge {
      font-size: 10px;
      line-height: 1.2;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid transparent;
    }
    .badge-competitor {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }
    .badge-customer {
      background: #dbeafe;
      color: #1e40af;
      border-color: #bfdbfe;
    }

    .site-meta {
      font-size: 11px;
      color: #64748b;
      margin-top: 2px;
      line-height: 1.4;
    }

    /* POPUP STYLE (light) */
    .leaflet-popup-content-wrapper {
      background:#ffffff;
      color:#0f172a;
      border-radius:12px;
      border:1px solid #cbd5e1;
      box-shadow:0 24px 40px rgb(0 0 0 / .2);
    }
    .leaflet-popup-tip {
      background:#ffffff;
      border:1px solid #cbd5e1;
    }
    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#0f172a;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:#475569;
      line-height:1.4;
    }

    /* LAYER CONTROL STYLE */
    .leaflet-control-layers {
      background:#ffffff !important;
      border:1px solid #cbd5e1 !important;
      border-radius:12px !important;
      color:#0f172a !important;
      box-shadow:0 20px 40px rgb(0 0 0 / .15) !important;
      font-size:12px;
      line-height:1.4;
      padding:6px 8px;
    }
    .leaflet-control-layers-expanded {
      background:#ffffff !important;
      color:#0f172a !important;
    }
    .leaflet-control-layers-list label {
      color:#334155;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
      font-size:12px;
      line-height:1.4;
    }

    @media (max-width:900px){
      main.page-body {
        grid-template-columns: 1fr;
      }
      aside.side-panel {
        position: relative;
        height: auto;
        max-height: 45vh;
        order: -1;
        border-left: none;
        border-bottom: 1px solid var(--border-card);
      }
      .map-wrap {
        height: 55vh;
      }
    }

    @media (min-width:901px){
      .map-wrap {
        height: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER / NAV -->
  <header class="site-header">
    <div class="brand-block">
      <div class="brand-title">
        <span>‚öîÔ∏è ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á & ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
      </div>
      <div class="brand-sub">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏±‡∏®‡∏°‡∏µ / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏ö Hub | ‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤ ‚Üí ‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î
      </div>
    </div>

    <nav class="main-nav">
      <a href="index.html"><span class="emoji">üè†</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span></a>
      <a href="map.html"><span class="emoji">üó∫Ô∏è</span><span>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span></a>
      <a href="competition.html" class="active"><span class="emoji">‚öîÔ∏è</span><span>‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á&‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span></a>
      <a href="logistics.html"><span class="emoji">üöö</span><span>‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á</span></a>
      <a href="population.html"><span class="emoji">üë•</span><span>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£</span></a>
      <a href="supply.html"><span class="emoji">‚ôªÔ∏è</span><span>‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span></a>
      <a href="capacity.html"><span class="emoji">üè≠</span><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</span></a>
      <a href="risk.html"><span class="emoji">üö®</span><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</span></a>
    </nav>
  </header>

  <!-- PAGE BODY -->
  <main class="page-body">
    <!-- MAP -->
    <section class="map-wrap">
      <div id="map"></div>
    </section>

    <!-- RIGHT PANEL -->
    <aside class="side-panel">

      <!-- 1. FILTER / CONTROL -->
      <div class="panel-card">
        <div class="panel-headline">
          <span>üéØ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</span>
        </div>
        <div class="panel-desc">
          ‡πÄ‡∏£‡∏≤‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏£‡∏≠‡∏ö "Hub ‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á" ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
          ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏î‡∏π
        </div>

        <div class="radius-row">
          <label for="radiusKm"><strong>‡∏£‡∏±‡∏®‡∏°‡∏µ (‡∏Å‡∏°.)</strong></label>
          <input id="radiusKm" type="number" min="0.5" step="0.5" value="5" />
          <span id="radiusInfo" style="color:#475569;">‚âà ‡∏ß‡∏á‡∏Å‡∏•‡∏° 5 ‡∏Å‡∏°.</span>
        </div>

        <div style="font-size:12px;color:#0f172a;font-weight:600;margin-bottom:6px;">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π:
        </div>

        <div id="categoryList" class="category-list">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏° checkbox ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏à‡∏≤‡∏Å CSV -->
        </div>

        <div class="filter-actions">
          <button id="clearBtn" class="btn-small">Clear</button>
          <button id="applyBtn" class="btn-small" style="border-color:#0ea5e9;color:#0ea5e9;">
            Apply
          </button>
        </div>

        <div style="font-size:11px;color:#64748b;line-height:1.4;">
          ‚óè ‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á = ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏• / ‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏ï‡∏£‡∏á ‡πÜ)<br/>
          ‚óè ‡∏à‡∏∏‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô = ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° / ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢)<br/>
          ‚óè ‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏à‡∏≤‡∏á = ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å<br/>
          ‚óè ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞ = ‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å Hub ‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô
        </div>
      </div>

      <!-- 2. SUMMARY -->
      <div class="panel-card">
        <div class="panel-headline">
          <span>üìä ‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ô‡∏µ‡πâ</span>
        </div>

        <div class="mini-stats">
          <div class="stat-box">
            <div class="stat-label">‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á (‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•)</div>
            <div class="stat-value stat-competitor" id="competitorCount">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</div>
            <div class="stat-value stat-customer" id="customerCount">0</div>
          </div>
        </div>

        <div class="panel-desc" style="margin-bottom:8px;">
          ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
        </div>

        <div id="siteList" class="list-sites">
          <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
        </div>
      </div>

      <!-- 3. NOTE STRATEGY -->
      <div class="panel-card">
        <div class="panel-headline">
          <span>üí° ‡∏°‡∏∏‡∏°‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå</span>
        </div>
        <div style="font-size:12px; color:#475569; line-height:1.5;">
          - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏°‡∏≤‡∏Å‡πÉ‡∏Å‡∏•‡πâ Hub = ‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô (‡∏£‡∏≤‡∏Ñ‡∏≤, ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡πá‡∏ö)<br/><br/>
          - ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏ß‡∏Å‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© / ‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å / ‡∏™‡∏∏‡∏£‡∏≤ ‡∏Å‡∏£‡∏∞‡∏à‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÉ‡∏Å‡∏•‡πâ Hub = ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏£‡∏≤‡∏ï‡πà‡∏≥ ‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏Å (hub) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡∏¥‡πà‡∏á‡∏™‡∏±‡πâ‡∏ô ‡∏ß‡∏ô‡∏£‡∏ñ‡πÑ‡∏ß
        </div>
      </div>

    </aside>
  </main>

  <!-- SCRIPT -->
  <script>
    // ---------------------------
    // CSV parser: category,name,detail,"address,maybe,commas",lat,lng
    // ---------------------------
    function parseFactoriesCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const factories = [];

      let startIndex = 0;
      const headerLine = lines[0].toLowerCase();
      if (
        headerLine.includes('category') ||
        headerLine.includes('name') ||
        headerLine.includes('lat')
      ) {
        startIndex = 1;
      }

      for (let i = startIndex; i < lines.length; i++) {
        let row = lines[i].trim();
        if (!row) continue;

        // ‡∏à‡∏±‡∏ö address ‡πÉ‡∏ô "..."
        let address = '';
        const addressMatch = row.match(/"([^"]*)"/);
        if (addressMatch) {
          address = addressMatch[1].trim();
          row = row.replace(addressMatch[0], '##ADDRESS_PLACEHOLDER##');
        }

        const parts = row.split(',').map(p => p.trim());
        if (parts.length < 6) continue;

        const category = parts[0] || '';
        const name = parts[1] || '';
        const detail = parts[2] || '';
        let rebuiltAddress = parts[3];
        if (rebuiltAddress === '##ADDRESS_PLACEHOLDER##') {
          rebuiltAddress = address;
        }

        const lat = parseFloat(parts[4]);
        const lng = parseFloat(parts[5]);
        if (isNaN(lat) || isNaN(lng)) continue;

        factories.push({
          category,
          name,
          detail,
          address: rebuiltAddress,
          lat,
          lng
        });
      }

      return factories;
    }

    // ---------------------------
    // ‡∏à‡∏∏‡∏î Hub ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
    // ---------------------------
    const hub = {
      name: "‡∏•‡∏≤‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏¥‡∏á‡πÅ‡∏î‡∏á (Hub ‡πÄ‡∏£‡∏≤)",
      address: "‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏¢‡πÉ‡∏¢‡∏£‡∏±‡∏Å ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£",
      lat: 13.565126,
      lng: 100.279895
    };

    // ---------------------------
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
    // ---------------------------
    let map;
    let streetLayer, satelliteLayer;
    let layerHub;
    let layerSites;        // markers
    let layerRadiusCircle; // circle radius
    let layerRoutes;       // dashed polylines from hub
    let allFactories = [];
    let uniqueCategories = [];

    // ---------------------------
    // Utils
    // ---------------------------
    function isCompetitor(factory) {
      // ‡∏ñ‡πâ‡∏≤ category ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•" ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏£‡∏±‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
      return factory.category && factory.category.includes("‡∏£‡∏µ‡πÑ‡∏ã‡πÄ‡∏Ñ‡∏¥‡∏•");
    }

    function distanceKm(lat1,lng1,lat2,lng2){
      // haversine
      const R = 6371; // km
      const dLat = (lat2-lat1)*Math.PI/180;
      const dLng = (lng2-lng1)*Math.PI/180;
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
                Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
                Math.sin(dLng/2)*Math.sin(dLng/2);
      const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }

    function popupHTML(f) {
      return `
        <div class="popup-title">${f.name || "-"}</div>
        <div class="popup-desc">
          <div><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${f.category || "-"}</div>
          <div><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${f.detail || "-"}</div>
          <div><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${f.address || "-"}</div>
          <div><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> ${f.lat.toFixed(5)}, ${f.lng.toFixed(5)}</div>
        </div>
      `;
    }

    // ‡πÄ‡∏ï‡∏¥‡∏° list ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
    function renderSiteList(filtered) {
      const wrap = document.getElementById("siteList");
      wrap.innerHTML = "";

      filtered.forEach(f => {
        const km = distanceKm(hub.lat,hub.lng,f.lat,f.lng).toFixed(2);
        const badgeClass = isCompetitor(f) ? "badge-competitor" : "badge-customer";
        const badgeText = isCompetitor(f) ? "‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á" : "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢";
        const div = document.createElement("div");
        div.className = "site-entry";
        div.innerHTML = `
          <div class="site-name-line">
            <div>${f.name || "-"}</div>
            <div class="badge ${badgeClass}">${badgeText}</div>
          </div>
          <div class="site-meta">
            ${f.category || ""} <br/>
            ${f.address || ""} <br/>
            ~ ${km} ‡∏Å‡∏°. ‡∏à‡∏≤‡∏Å Hub
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç summary
    function renderSummary(filtered){
      const compCount = filtered.filter(isCompetitor).length;
      const custCount = filtered.filter(f => !isCompetitor(f)).length;
      document.getElementById("competitorCount").textContent = compCount;
      document.getElementById("customerCount").textContent = custCount;
    }

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function getUIState(){
      const radiusKmInput = document.getElementById("radiusKm");
      const radiusKm = parseFloat(radiusKmInput.value) || 0;

      const checkedCats = Array.from(
        document.querySelectorAll(".category-item input[type=checkbox]:checked")
      ).map(cb => cb.value);

      return { radiusKm, checkedCats };
    }

    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ + ‡∏´‡∏°‡∏ß‡∏î
    function filterFactories(){
      const {radiusKm, checkedCats} = getUIState();

      return allFactories.filter(f => {
        // filter by category selection
        if (checkedCats.length>0 && !checkedCats.includes(f.category)) {
          return false;
        }

        // filter by distance
        const d = distanceKm(hub.lat,hub.lng,f.lat,f.lng);
        return d <= radiusKm;
      });
    }

    // ‡∏ß‡∏≤‡∏î map layer ‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏£‡∏≠‡∏á
    function renderMapLayers(){
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
      layerSites.clearLayers();
      layerRoutes.clearLayers();
      layerRadiusCircle.clearLayers();

      const {radiusKm} = getUIState();
      const filtered = filterFactories();

      // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ
      const radiusMeters = radiusKm * 1000;
      const circle = L.circle([hub.lat, hub.lng], {
        radius: radiusMeters,
        color: "#0ea5e9",
        weight: 1,
        fillColor: "#0ea5e9",
        fillOpacity: 0.08
      });
      circle.addTo(layerRadiusCircle);

      // ‡∏ß‡∏≤‡∏î marker + ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞‡∏à‡∏≤‡∏Å hub
      filtered.forEach(f => {
        const fillColor = isCompetitor(f)
          ? getComputedStyle(document.documentElement).getPropertyValue('--recycle-color').trim()
          : getComputedStyle(document.documentElement).getPropertyValue('--customer-color').trim();

        const marker = L.circleMarker([f.lat,f.lng], {
          radius: 6,
          color: "#fff",
          weight: 1.5,
          fillColor,
          fillOpacity: 0.9
        }).bindPopup(popupHTML(f));
        marker.addTo(layerSites);

        // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å hub ‚Üí ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô
        const line = L.polyline(
          [
            [hub.lat, hub.lng],
            [f.lat, f.lng]
          ],
          {
            color: "#475569",
            weight: 1,
            opacity: 0.7,
            dashArray: "4 4" // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞
          }
        );
        line.addTo(layerRoutes);
      });

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï panel
      renderSiteList(filtered);
      renderSummary(filtered);

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ
      const radiusInfo = document.getElementById("radiusInfo");
      radiusInfo.textContent = `‚âà ‡∏ß‡∏á‡∏Å‡∏•‡∏° ${radiusKm} ‡∏Å‡∏°.`;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á checkbox ‡∏´‡∏°‡∏ß‡∏î
    function buildCategoryList(){
      const box = document.getElementById("categoryList");
      box.innerHTML = "";
      uniqueCategories.forEach(cat => {
        const div = document.createElement("label");
        div.className = "category-item";
        div.innerHTML = `
          <input type="checkbox" value="${cat}">
          <span>${cat}</span>
        `;
        box.appendChild(div);
      });
    }

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏∏‡∏Å checkbox
    function clearCategories(){
      const cbs = document.querySelectorAll(".category-item input[type=checkbox]");
      cbs.forEach(cb => { cb.checked = false; });
    }

    // ---------------------------
    // initMap()
    // ---------------------------
    function initMap(){
      streetLayer = L.tileLayer(
        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors"
        }
      );

      satelliteLayer = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        {
          maxZoom: 19,
          attribution: "Tiles ¬© Esri"
        }
      );

      map = L.map("map", {
        center: [hub.lat, hub.lng],
        zoom: 12,
        layers: [streetLayer]
      });

      layerHub = L.layerGroup().addTo(map);
      layerSites = L.layerGroup().addTo(map);
      layerRoutes = L.layerGroup().addTo(map);
      layerRadiusCircle = L.layerGroup().addTo(map);

      // ‡∏°‡∏≤‡∏£‡πå‡∏Ñ‡∏à‡∏∏‡∏î HUB ‡πÄ‡∏£‡∏≤
      const hubColor = getComputedStyle(document.documentElement)
        .getPropertyValue('--hub-color')
        .trim();

      const hubMarker = L.circleMarker([hub.lat, hub.lng], {
        radius: 10,
        color: "#fff",
        weight: 2,
        fillColor: hubColor,
        fillOpacity: 0.95
      }).bindPopup(`
        <div class="popup-title">‚òÖ ${hub.name}</div>
        <div class="popup-desc">
          <div><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</strong> ${hub.address}</div>
          <div><strong>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</strong> ${hub.lat}, ${hub.lng}</div>
        </div>
      `);

      hubMarker.addTo(layerHub);

      // layer control
      const baseMaps = {
        "‡πÇ‡∏´‡∏°‡∏î‡∏ñ‡∏ô‡∏ô (OSM)": streetLayer,
        "‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Esri)": satelliteLayer
      };
      const overlayMaps = {
        "Hub ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤": layerHub,
        "‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á": layerSites,
        "‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£": layerRadiusCircle,
        "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á Hub ‚Üí ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô": layerRoutes
      };
      L.control.layers(baseMaps, overlayMaps, { collapsed:false }).addTo(map);
    }

    // ---------------------------
    // STARTUP
    // ---------------------------
    fetch("data/factories.csv",{cache:"no-store"})
      .then(r=>r.text())
      .then(txt=>{
        allFactories = parseFactoriesCSV(txt);

        // unique categories
        const catSet = new Set();
        allFactories.forEach(f => {
          if (f.category && f.category.trim() !== "") {
            catSet.add(f.category.trim());
          }
        });
        uniqueCategories = Array.from(catSet).sort();

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° UI
        buildCategoryList();

        // init map
        initMap();

        // ‡∏õ‡∏∏‡πà‡∏° Apply
        document.getElementById("applyBtn").addEventListener("click", ()=>{
          renderMapLayers();
        });

        // ‡∏õ‡∏∏‡πà‡∏° Clear
        document.getElementById("clearBtn").addEventListener("click", ()=>{
          clearCategories();
          renderMapLayers();
        });

        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        document.getElementById("radiusKm").addEventListener("change", ()=>{
          renderMapLayers();
        });

        // ‡πÄ‡∏£‡∏¥‡πà‡∏° render ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        renderMapLayers();
      })
      .catch(err=>{
        console.error("‡πÇ‡∏´‡∏•‡∏î factories.csv ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:", err);
        alert("‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (factories.csv)");
      });
  </script>

</body>
</html>
