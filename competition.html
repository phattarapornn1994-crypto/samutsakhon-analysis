<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>การวิเคราะห์การแข่งขัน & ลูกค้า (สมุทรสาคร)</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
    }

    header {
      background: #1e293b;
      padding: 12px 16px;
      border-bottom: 1px solid #334155;
      font-size: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header nav a {
      color: #94a3b8;
      margin-right: 12px;
      text-decoration: none;
      font-size: 13px;
    }
    header nav a:hover {
      color: #fff;
    }

    #map-wrapper {
      position: relative;
      background: #000;
    }

    #map {
      width: 100%;
      height: 100%;
      min-height: 400px;
      position: absolute;
      inset: 0;
    }

    /* แผงควบคุมด้านบนซ้าย */
    .control-panel {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 500;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 60px rgb(0 0 0 / .7);
      color: #cbd5e1;
      font-size: 13px;
      line-height: 1.4;
      width: 260px;
      max-width: calc(100vw - 32px);
    }

    .control-panel h2 {
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    .field {
      margin-bottom: 12px;
      display: grid;
      gap: 4px;
    }

    .field label {
      font-size: 12px;
      color: #94a3b8;
    }

    .field select,
    .field input[type="range"] {
      width: 100%;
      background: #1e293b;
      border: 1px solid #475569;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      padding: 6px 8px;
    }

    .radius-readout {
      font-size: 12px;
      color: #fff;
      font-weight: 500;
      text-align: right;
    }

    .stat-panel {
      position: absolute;
      bottom: 16px;
      left: 16px;
      z-index: 500;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 12px;
      color: #cbd5e1;
      line-height: 1.4;
      box-shadow: 0 20px 60px rgb(0 0 0 / .7);
      min-width: 200px;
    }

    .stat-panel .stat-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    footer {
      color:#475569;
      background:#0f172a;
      font-size:12px;
      text-align:center;
      padding:12px 0 16px;
      border-top:1px solid #334155;
    }

    /* popup style ให้เหมือนหน้า map */
    .leaflet-popup-content-wrapper {
      background:#1e293b;
      color:#f8fafc;
      border-radius:12px;
      border:1px solid #475569;
      box-shadow:0 20px 60px rgb(0 0 0 / .8);
    }
    .leaflet-popup-tip {
      background:#1e293b;
      border:1px solid #475569;
    }
    .popup-title {
      font-size:14px;
      font-weight:600;
      color:#fff;
      margin-bottom:4px;
      line-height:1.4;
    }
    .popup-desc {
      font-size:12px;
      color:#cbd5e1;
      line-height:1.4;
    }
  </style>
</head>
<body>
  <header>
    <div style="color:#fff;font-weight:600;font-size:13px;">
      วิเคราะห์การแข่งขัน / ลูกค้า – สมุทรสาคร
    </div>
    <nav>
      <a href="index.html">หน้าหลัก</a>
      <a href="map.html">แผนที่รวม</a>
      <a href="population.html">ประชากร</a>
      <a style="color:#fff;font-weight:600;" href="competition.html">การแข่งขัน</a>
      <a href="risk.html">ความเสี่ยง</a>
    </nav>
  </header>

  <main id="map-wrapper">
    <div id="map"></div>

    <!-- control panel -->
    <section class="control-panel">
      <h2>ตัวกรองพื้นที่</h2>

      <!-- โหมดวิเคราะห์ -->
      <div class="field">
        <label for="modeSelect">โหมดการดู</label>
        <select id="modeSelect">
          <option value="competitors">ดูคู่แข่ง (โรงงานรีไซเคิล)</option>
          <option value="customers">ดูลูกค้าเป้าหมาย (เลือกประเภท)</option>
        </select>
      </div>

      <!-- ประเภทลูกค้า -->
      <div class="field" id="customerTypeField" style="display:none;">
        <label for="customerTypeSelect">ประเภทโรงงานลูกค้า</label>
        <select id="customerTypeSelect">
          <option value="all">ทั้งหมด</option>
          <option value="โรงงานอาหารและเครื่องดื่ม">โรงงานอาหารและเครื่องดื่ม</option>
          <option value="โรงงานอาหารสัตว์">โรงงานอาหารสัตว์</option>
          <option value="โรงงานประกอบชิ้นส่วน">โรงงานประกอบชิ้นส่วน</option>
          <option value="โรงงานผลิตกระดาษ">โรงงานผลิตกระดาษ</option>
          <option value="โรงงานผลิตเม็ดพลาสติก">โรงงานผลิตเม็ดพลาสติก</option>
          <option value="โรงงานพลาสติกอื่นๆ">โรงงานพลาสติกอื่นๆ</option>
          <option value="โรงงานสารเคมี">โรงงานสารเคมี</option>
          <option value="โรงงานทอผ้า">โรงงานทอผ้า / สิ่งทอ</option>
          <!-- คุณสามารถเพิ่ม option อื่น ๆ ได้เอง -->
        </select>
      </div>

      <!-- รัศมี -->
      <div class="field">
        <label for="radiusInput">รัศมีรอบลานกระทิงแดง (เมตร)</label>
        <input id="radiusInput" type="range" min="500" max="7000" step="1000" value="3000" />
        <div class="radius-readout">
          <span id="radiusLabel">3,000 m</span>
        </div>
      </div>

      <div style="font-size:11px;color:#94a3b8;line-height:1.4;">
        จุดแดง = คู่แข่ง (รีไซเคิล)<br/>
        จุดฟ้า = ลูกค้าที่เลือก<br/>
        วงแดง = พื้นที่เข้าถึง (delivery zone)
      </div>
    </section>

    <!-- สถิติ -->
    <section class="stat-panel">
      <div class="stat-line">
        <span>คู่แข่งในรัศมี</span>
        <strong id="competitorCount">-</strong>
      </div>
      <div class="stat-line">
        <span>ลูกค้าในรัศมี</span>
        <strong id="customerCount">-</strong>
      </div>
    </section>
  </main>

  <footer>
    © สมุทรสาคร spatial analysis · competition view
  </footer>

  <script>
    // ------------------------------
    // 1) จุดศูนย์กลาง: ลานกระทิงแดงใหม่
    // ------------------------------
    const hubLat = 13.565126;
    const hubLng = 100.279895;
    const hubLatLng = [hubLat, hubLng];

    // ------------------------------
    // 2) สร้างแผนที่ Leaflet
    // ------------------------------
    const map = L.map("map", {
      center: hubLatLng,
      zoom: 12,
      scrollWheelZoom: true
    });

    // พื้นฐานถนน
    const street = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 20,
        attribution: "© OpenStreetMap"
      }
    ).addTo(map);

    // ดาวเทียม (Esri)
    const satellite = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        maxZoom: 20,
        attribution: "Tiles © Esri"
      }
    );

    L.control.layers(
      {
        "ถนน (OSM)": street,
        "ดาวเทียม": satellite
      },
      null,
      { position: "topleft" }
    ).addTo(map);

    // ------------------------------
    // 3) Marker ของลานกระทิงแดง
    // ------------------------------
    const hubMarker = L.circleMarker(hubLatLng, {
      radius: 8,
      color: "#ff0000",
      fillColor: "#ff4d4d",
      fillOpacity: 1,
      weight: 2
    })
    .addTo(map)
    .bindPopup(
      `<div class="popup-title">ลานกระทิงแดง (Hub)</div>
       <div class="popup-desc">
        ถนนสายใยรัก<br/>
        พิกัด: ${hubLat.toFixed(6)}, ${hubLng.toFixed(6)}
       </div>`
    );

    // ------------------------------
    // 4) เตรียม circle (รัศมี)
    // ------------------------------
    let radiusCircle = null;

    function drawRadiusCircle(radiusMeters) {
      if (radiusCircle) {
        map.removeLayer(radiusCircle);
      }
      radiusCircle = L.circle(hubLatLng, {
        radius: radiusMeters,
        color: "#ff0000",
        weight: 2,
        fillColor: "#ff0000",
        fillOpacity: 0.08
      }).addTo(map);
    }

    // ------------------------------
    // 5) โหลดข้อมูลโรงงานจาก factories.json
    // ------------------------------
    let factoryData = [];
    let allFactoryMarkers = []; // เก็บ marker obj + meta

    fetch("../data/factories.json")
      .then(res => res.json())
      .then(data => {
        factoryData = data;
        buildMarkers();
        updateView(); // วาดครั้งแรก
      })
      .catch(err => {
        console.error("โหลด factories.json ไม่ได้", err);
      });

    // ------------------------------
    // 6) สร้าง marker ของทุกโรงงาน แล้วเก็บไว้
    // ------------------------------
    function buildMarkers() {
      allFactoryMarkers.forEach(m => map.removeLayer(m.leafletMarker));
      allFactoryMarkers = [];

      factoryData.forEach(item => {
        const { category, name, desc, lat, lng } = item;

        if (!lat || !lng) return; // ถ้าไม่มีพิกัด ข้าม

        const marker = L.circleMarker([lat, lng], {
          radius: 6,
          color: "#38bdf8",      // ฟ้าอ่อน default
          fillColor: "#38bdf8",
          fillOpacity: 0.9,
          weight: 2
        });

        marker.bindPopup(
          `<div class="popup-title">${name}</div>
           <div class="popup-desc">
             ประเภท: ${category}<br/>
             ${desc || ""}
           </div>`
        );

        allFactoryMarkers.push({
          leafletMarker: marker,
          category,
          lat,
          lng
        });

        marker.addTo(map);
      });
    }

    // ------------------------------
    // 7) Logic การคำนวณอยู่ในรัศมีไหม
    // ------------------------------
    function distanceMeters(lat1, lng1, lat2, lng2) {
      const R = 6371000; // m
      const toRad = d => (d * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLng / 2) *
          Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // ------------------------------
    // 8) อัปเดตการแสดงผลตามโหมด / ประเภท / รัศมี
    // ------------------------------
    function updateView() {
      const mode = document.getElementById("modeSelect").value;
      const custType = document.getElementById("customerTypeSelect").value;
      const radiusMeters = parseInt(document.getElementById("radiusInput").value, 10);

      // วาดวง
      drawRadiusCircle(radiusMeters);

      let competitorCount = 0;
      let customerCount = 0;

      allFactoryMarkers.forEach(obj => {
        const m = obj.leafletMarker;
        const d = distanceMeters(hubLat, hubLng, obj.lat, obj.lng);
        const inRadius = d <= radiusMeters;

        // default ซ่อนหมดก่อน
        m.setStyle({
          radius: 0,
          opacity: 0,
          fillOpacity: 0
        });

        // โหมดคู่แข่ง = category === "โรงงานรีไซเคิล"
        if (mode === "competitors") {
          if (obj.category === "โรงงานรีไซเคิล") {
            // แสดง
            m.setStyle({
              radius: 6,
              color: inRadius ? "#ff0000" : "#f87171",
              fillColor: inRadius ? "#ff0000" : "#f87171",
              fillOpacity: 1,
              weight: 2,
              opacity: 1
            });

            if (inRadius) competitorCount += 1;
          }
        }

        // โหมดลูกค้า = category != "โรงงานรีไซเคิล"
        if (mode === "customers") {
          // เงื่อนไขประเภทลูกค้า
          const matchType = (custType === "all" || obj.category === custType);

          if (obj.category !== "โรงงานรีไซเคิล" && matchType) {
            // แสดง
            m.setStyle({
              radius: 6,
              color: inRadius ? "#38bdf8" : "#93c5fd",
              fillColor: inRadius ? "#38bdf8" : "#93c5fd",
              fillOpacity: 1,
              weight: 2,
              opacity: 1
            });

            if (inRadius) customerCount += 1;
          }
        }
      });

      document.getElementById("competitorCount").textContent = competitorCount;
      document.getElementById("customerCount").textContent = customerCount;
    }

    // ------------------------------
    // 9) UI events
    // ------------------------------
    const modeSelectEl = document.getElementById("modeSelect");
    const customerTypeFieldEl = document.getElementById("customerTypeField");
    const customerTypeSelectEl = document.getElementById("customerTypeSelect");
    const radiusInputEl = document.getElementById("radiusInput");
    const radiusLabelEl = document.getElementById("radiusLabel");

    modeSelectEl.addEventListener("change", () => {
      // ซ่อน/โชว์ dropdown ประเภทลูกค้า
      if (modeSelectEl.value === "customers") {
        customerTypeFieldEl.style.display = "block";
      } else {
        customerTypeFieldEl.style.display = "none";
      }
      updateView();
    });

    customerTypeSelectEl.addEventListener("change", () => {
      updateView();
    });

    radiusInputEl.addEventListener("input", () => {
      const val = parseInt(radiusInputEl.value, 10);
      radiusLabelEl.textContent = val.toLocaleString("en-US") + " m";
      updateView();
    });

    // ตั้งค่า label เริ่มต้น
    radiusLabelEl.textContent = parseInt(radiusInputEl.value,10).toLocaleString("en-US") + " m";
  </script>
</body>
</html>
